<style>
    .cust_notif_prf_ {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 1rem;
        position: relative;
        margin-right: 15px;
    }

    .badge1 {
        position: absolute;
        top: -10px;
        right: -10px;
        padding: 0px 7px;
        border-radius: 50%;
        background: red;
        color: white;
    }

    #notifDropdownBtn:hover {
        color: #0d6efd;
    }

    #notifDropdownMenu {
        position: absolute;
        top: 50px;
        /* adjust distance from bell */
        right: 0;
        z-index: 9999;
        min-width: 300px;
        max-height: 300px;
        overflow-y: auto;
        border-radius: 0.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #notifDropdownBtn .fa-bell {
        font-size: 28px;
        /* bigger bell size */
    }

    #notifDropdownBtn span {
        font-size: 12px;
        /* badge text size */
    }
</style>
<header>
    <div class="header_parent_cust">
        <div class="container-fluid main_header">
            <div class="logo_cust logo_cust">
                <a href="{{url('/')}}"> <img class="" src="{{ asset('public/images/logo.png') }}" alt="logo"></a>
                <div class="logo_content ">
                    <h4>{{ session('moduleName', 'Resource Pool Portal') }}</h4>
                    {{-- <p class="">National Highways & Infrastructure Development Corporation Ltd.</p> --}}
                </div>
                <div class="logo-details">
                    <i class="fa fa-bars" id="btn"></i>
                </div>
            </div>
            @auth
            @php
            $unreadNotifications = auth()->user()->unreadNotifications;
            $readNotifications = auth()->user()->readNotifications;
            $unreadCount = $unreadNotifications->count();

            // Separate overdue (>=3 days) and recent notifications
            $overdueNotifications = $unreadNotifications->filter(function ($notification) {
            return $notification->created_at->diffInDays(now()) >= 3;
            });

            $recentNotifications = $unreadNotifications->filter(function ($notification) {
            return $notification->created_at->diffInDays(now()) < 3;
                });

                $hasOverdue=$overdueNotifications->count() > 0;
                @endphp

                <div class="cust_notif_prf_">
                    <!-- üîî Notification Bell -->
                    <button id="notifDropdownBtn" type="button" class="relative text-gray-600 hover:text-blue-600">
                        <i class="fa fa-bell fa-2x"></i>

                        <!-- Total unread badge -->
                        @if($unreadCount > 0)
                        <span class="badge1">{{ $unreadCount }}</span>
                        @endif

                        <!-- üî¥ Ping dot if any overdue -->
                        @if($hasOverdue)
                        <span class="absolute top-0 right-0 block h-3 w-3 bg-red-600 rounded-full ring-2 ring-white animate-ping"></span>
                        @endif
                    </button>

                    <!-- üîΩ Notification Dropdown -->
                    <div id="notifDropdownMenu"
                        class="hidden bg-white divide-y divide-gray-100 rounded-lg shadow-lg border border-gray-200"
                        style="max-height: 320px; overflow-y: auto; min-width: 320px;">

                        <ul class="py-2 text-sm text-gray-700">
                            <li class="dropdown-header fw-bold text-center bg-gray-100 border-b border-gray-200">
                                Notifications
                            </li>

                            {{-- üî¥ Overdue Notifications --}}
                            @if($overdueNotifications->count() > 0)
                            <li class="dropdown-header fw-bold text-center bg-red-600 text-white">
                                ‚ö†Ô∏è Overdue Notifications
                            </li>

                            @foreach($overdueNotifications as $notification)
                            @php $daysPassed = $notification->created_at->diffInDays(now()); @endphp
                            <li>
                                <a href="{{ route('notification.read', $notification->id) }}"
                                    class="block px-4 py-2 bg-red-50 border-l-4 border-red-500 text-red-700 font-semibold hover:bg-red-100">
                                    {{ $notification->data['message'] ?? 'New notification' }}<br>
                                    <small class="text-red-500 font-bold">
                                        ‚ö†Ô∏è {{ $daysPassed }} days passed ‚Äî needs attention
                                    </small>
                                </a>
                            </li>
                            @endforeach

                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            @endif

                            {{-- üü¢ Recent Notifications --}}
                            @if($recentNotifications->count() > 0)
                            <li class="dropdown-header fw-bold text-center bg-light">
                                Recent Notifications
                            </li>
                            @foreach($recentNotifications as $notification)
                            <li>
                                <a href="{{ route('notification.read', $notification->id) }}"
                                    class="block px-4 py-2 font-semibold text-gray-900 hover:bg-gray-100">
                                    {{ $notification->data['message'] ?? 'New notification' }}<br>
                                    <small class="text-muted">
                                        {{ $notification->created_at->diffForHumans() }}
                                    </small>
                                </a>
                            </li>
                            @endforeach
                            @endif

                            {{-- üïì Read Notifications --}}
                            @if($readNotifications->count() > 0)
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li class="dropdown-header fw-bold text-center bg-light">
                                Read Notifications
                            </li>
                            @foreach($readNotifications as $notification)
                            <li>
                                <a href="{{ route('notification.read', $notification->id) }}"
                                    class="block px-4 py-2 text-gray-500 hover:bg-gray-100">
                                    {{ $notification->data['message'] ?? 'Notification' }}<br>
                                    <small class="text-muted">{{ $notification->created_at->diffForHumans() }}</small>
                                </a>
                            </li>
                            @endforeach
                            @endif

                            {{-- ‚ùå No Notifications --}}
                            @if($unreadCount + $readNotifications->count() === 0)
                            <li>
                                <p class="text-center text-gray-500 px-4 py-2">No notifications</p>
                            </li>
                            @endif
                        </ul>
                    </div>
                
                @endauth


                <div class="cust_notif_prf_">
                    <div class="drop_profile_bg" id="dropdownAvatarNameButton" data-dropdown-toggle="dropdownAvatarName">
                        <button class="" type="button">
                            <img class="" src="{{ asset('public/images/user-sample.png') }}" alt="user photo">
                        </button>
                        <a class="drop_cont_cust">
                            {{ ucwords(@Auth::user()->name) }}
                            <span class="">Profile</span>
                        </a>
                        <div id="dropdownAvatarName" class="z-10 hidden divide-y divide-gray-100 shadow-xl w-44  ">
                            <ul class="after_dropdown">
                                @if (auth()->user() && auth()->user()->getRoleNames()->isEmpty())
                                <li><a href="{{ route('candidate.applicantProfile') }}">View Profile</a></li>
                                <li><a href="{{ route('candidate.change-password') }}">Change Password</a></li>
                                <li><a href="{{ route('candidate.login-history') }}">Login History</a></li>
                                <li>
                                    <form action="{{ route('candidate.logout') }}" method="POST" class="d-inline">
                                        @csrf
                                        <button type="submit" class="btn btn-link p-0 m-0 align-baseline">
                                            Logout
                                        </button>
                                    </form>
                                </li>
                                @else
                                @auth
                                <li>
                                    <a href="{{ route('user-config.show', Crypt::encrypt(Auth::id())) }}">Profile</a>
                                </li>
                                <li>
                                    <a href="{{ route('change-password', Crypt::encrypt(Auth::id())) }}"
                                        class="">Change Password</a>
                                </li>
                                <li><a href="{{ route('user.login.history') }}">Login History</a></li>
                                <li>
                                    <form action="{{ route('logout') }}" method="POST" class="d-inline">
                                        @csrf
                                        <button type="submit" class="btn btn-link p-0 m-0 align-baseline">
                                            Logout
                                        </button>
                                    </form>
                                </li>
                                @endauth
                                @endif
                            </ul>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    </div>
</header>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('notifDropdownBtn');
        const menu = document.getElementById('notifDropdownMenu');

        if (btn && menu) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                menu.classList.toggle('hidden');
            });

            document.addEventListener('click', function(e) {
                if (!btn.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });
        }
    });
</script>