<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Http\Controllers\Notification\UserNotificationController;
use App\Models\{Role,User,RefApplicantPersonalDetails,NhidclAplicantEducationDetails, NhidclApplicantWorkExperienceDetails, RefProjectState,RefCourse,RefQualification,RefBoardUniversityCollege,RefMainSubject,RefCourseMode,RefPassingYear,RefAreaExperties,RefJobType};
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\{Log,Mail,Auth,Crypt,Gate,File,Validator,Session};
use RealRashid\SweetAlert\Facades\Alert;
use Yajra\DataTables\Facades\DataTables;
use App\Mail\NewUserSetPasswordMail;
use App\Models\{DepartmentMaster,RefCaste, RefEmployeeType,RefOfficeType,RefState,DesignationMaster,UserActivity,Permission,NhidclUserStatus,RoleUser};
use Maatwebsite\Excel\Facades\Excel;
use App\Exports\UsersExport;
use App\Http\Controllers\UserActivityController;
use App\Http\Requests\Candidate\{EducationalDetailRequest,WorkExperienceDetailRequest};
use Exception;
use Carbon\Carbon;
use Symfony\Component\Mailer\Exception\TransportExceptionInterface;
use App\Models\EmployeeManagement\{NhidclEmployeePersonalDetails,NhidclEmployeeEducationDetails,NhidclEmployeeWorkExperienceDetails,NhidclEmployeeTrainingDetails,NhidclEmployeeOrganisationDetails};


class UserController extends Controller
{
    protected $userNotificationController;

    public function __construct(UserNotificationController $userNotificationController)
    {
        $this->userNotificationController = $userNotificationController;
        $this->middleware('permission:user config - view user|user config - view role')->only(['index']);
        $this->middleware('permission:user config - create user')->only(['create', 'store']);
        $this->middleware('permission:user config - view user|user config - profile')->only(['view']);
        $this->middleware('permission:user config - edit user')->only(['edit', 'update', 'resetPassword']);
        $this->middleware(['role:Super Admin', 'module.permission:user config - delete user'])->only(['destroy']);
        // $this->middleware(function ($request, $next) {
        //     session(['moduleName' => 'User Management System']);
        //     return $next($request);
        // });
    }

    /**
     * Display a listing of the resource.
     */
    public function index(Request $request)
    {
        $userQuery = User::where('is_deleted', '!=', '1')
            ->whereDoesntHave('roles', function ($query) {
                $query->where('name', 'Super Admin');
            });
        $users = $userQuery->orderBy('id', 'DESC')->get();

        $roles = Role::orderBy('id', 'DESC')->get();
        $totalUser = $userQuery->count();
        $nhidclUser = $userQuery->where('is_nhidcl_employee', '1')->count();
        $otherUser = $totalUser - $nhidclUser;
        $header = true;
        $sidebar = true;
        return view('user-config.index', compact('totalUser', 'nhidclUser', 'otherUser', 'users', 'roles', 'header', 'sidebar'));
    }


    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        $roles = Role::where('name', '!=', 'Super Admin')->orderBy('name', 'asc')->get();
        $department = DepartmentMaster::orderBy('name', 'asc')->get();

        $designation = DesignationMaster::orderBy('name', 'asc')->get();
        $employee_type = RefEmployeeType::orderBy('name', 'asc')->get();
        $office_type = RefOfficeType::orderBy('office_type_name', 'asc')->get();
        $state = RefState::orderBy('name', 'asc')->get();

        $authUser = Auth::user();
        $managerQuery = User::where('is_deleted', '!=', '1')
            ->orderBy('name')
            ->select(['id', 'name', 'email']);

        // If logged in user is Manager
        if ($authUser->hasRole('Manager')) {
            $managerQuery->whereHas('roles', function ($query) {
                $query->where('name', 'General Manager');
            })->where('id', '!=', $authUser->id);
        } else {
            // For other users → only Managers
            $managerQuery->whereHas('roles', function ($query) {
                $query->where('name', 'Manager');
            });
        }
        $managers = $managerQuery->get();
        $manager = $managerQuery->get();

        $header = TRUE;
        $sidebar = TRUE;
        return view('user-config.create', compact('header', 'sidebar', 'department', 'designation', 'employee_type', 'office_type', 'state', 'roles', 'managers', 'manager'));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        try {
            // 1. Validate the incoming request
            $validator = Validator::make($request->all(), [
                'name' => 'required|string|max:255',
                'email' => 'required|email|unique:ref_users,email',
                'mobile' => 'required|digits:10|unique:ref_users,mobile',
                'status' => 'required|in:0,1',
                'date_of_birth' => 'required|date|before:today',
                'user_type' => 'required|in:Applicant,External,Internal', // Valid types
            ]);

            if ($validator->fails()) {
                return redirect()->back()->withErrors($validator)->withInput();
            }

            // 2. Prepare user data for insertion
            $generatedPassword = 'password123'; // Replace with a more secure password generation mechanism

            $userData = [
                'name' => htmlspecialchars($request->name),
                'email' => htmlspecialchars($request->email),
                'mobile' => $request->mobile,
                'date_of_birth' => $request->date_of_birth,
                'status' => $request->status,
                'password' => bcrypt($generatedPassword),
                //'user_type' => $request->user_type,
                'created_by' => Auth::user()->id,
                'user_code' => rand() . time(),
            ];

            // 3. Create user
            $user = User::create($userData);

            // 4. Sync roles with the user
            $roles = $request->role ?? [];

            $filteredRoles = array_filter($roles, function ($roleId) {
                $role = Role::findByName($roleId);
                return $role && $role->name !== 'Super Admin';
            });

            if (count($filteredRoles)) {
                $rolesWithParentIds = array_map(function ($roleId) {
                    $role = Role::findByName($roleId);
                    $parentRoleId = $role ? $role->parent_role_id : null;
                    return [
                        'role_id' => $role->id,
                        'parent_role_id' => $parentRoleId,
                    ];
                }, $filteredRoles);

                // Sync roles with logging
                $user->syncRolesWithLogging($rolesWithParentIds);

                // Create role-user mappings
                foreach ($rolesWithParentIds as $role) {
                    RoleUser::create([
                        'ref_user_id' => $user->id,
                        'role_id' => $role['role_id'],
                        'parent_role_id' => $role['parent_role_id'],
                    ]);
                }
            }

            // Assign module name based on the role ID (if applicable)
            if (isset($rolesWithParentIds[0]['role_id']) && $rolesWithParentIds[0]['role_id'] == 130) {
                $user->module_name = 'Recruitment Portal';
            }
            $user->save();

            // 5. Send new user notification
            $this->userNotificationController->notifyNewUser(Auth::id(), $user->id);

            // 6. Generate password reset token and send the reset link to the user's email
            $token = app('auth.password.broker')->createToken($user);

            try {
                Mail::to($user->email)->send(new NewUserSetPasswordMail($user, $token));
            } catch (TransportExceptionInterface $e) {
                Log::error("Failed to send OTP mail: " . $e->getMessage());
            }

            // 7. Notify user of success
            Alert::success('Success', "Success! We've sent an email with instructions to access the user account.");

            // 8. Redirect to user creation page
            return redirect()->route('user-config.create');
        } catch (\Exception $e) {
            // Handle any unexpected errors
            Log::error("Error creating user: " . $e->getMessage());
            Alert::error('Error', 'Oops, something went wrong. Please try again later.');
            return redirect()->back()->withInput()->withErrors(['msg' => $e->getMessage()]);
        }
    }


    public function storeOld(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'name' => 'required|string|max:255',
                'email' => 'required|email|unique:ref_users,email',
                //'official_email' => 'required|email|unique:ref_users,official_email',
                'mobile' => 'required|digits:10|unique:ref_users,mobile',
                'status' => 'required|in:0,1',
                'date_of_birth' => 'required|date|before:today',
                //'ref_designation_id' => 'required|integer',
                'user_type' => 'required|in:Applicant,External,Internal', // Assuming these are the valid types
                //'ref_ext_emp_company_id' => 'nullable|integer',
                //'ref_ext_emp_designation_id' => 'nullable|integer',
            ]);

            if ($validator->fails()) {
                return redirect()->back()->withErrors($validator)->withInput();
            }

            // 2. Insert data after validation
            $generatedPassword = 'password123'; // Hardcoded password for now

            $insertData = array(
                'name' => htmlspecialchars($request->full_name),
                'email' => htmlspecialchars($request->email),
                //'official_email' => htmlspecialchars($request->official_email),
                'mobile' => $request->mobile_no,
                'date_of_birth' => $request->date_of_birth,
                //'date_of_joining' => $request->date_of_joining,
                'status' => $request->status,
                'password' => bcrypt($generatedPassword),
                //'ref_ext_emp_company_id' => $request->ref_ext_emp_company_id,
                //'ref_ext_emp_designation_id' => $request->ref_ext_emp_designation_id,
                'user_type' => $request->user_type,
                'created_by' => Auth::user()->id,
                'user_code' => rand() . time(),
                // 'ref_designation_id' => $request->ref_designation_id,
                // 'ref_department_id' => $request->ref_department_id,
                // 'address' => $request->address,
                // 'ref_office_type_id' => $request->ref_office_type_id,
                // 'currently_posted' => $request->currently_posted,
                // 'is_nhidcl_employee' => $request->is_nhidcl_employee,
                // 'reporting_manager_id' => $request->reporting_manager_id,
            );

            // 3. Create the user
            $user = User::create($insertData);
            /***********Syncing role and parent Role with user */
            $roles = $request->role ?? [];
            $filteredRoles = array_filter($roles, function ($roleId) {
                $role = Role::findByName($roleId);
                return $role && $role->name !== 'Super Admin';
            });

            $rolesWithParentIds = array_map(function ($roleId) {
                $role = Role::findByName($roleId);
                $parentRoleId = $role ? $role->parent_role_id : null;
                return [
                    'role_id' => $role->id,
                    'parent_role_id' => $parentRoleId
                ];
            }, $filteredRoles);
            $user->syncRolesWithLogging($rolesWithParentIds);

            if ($rolesWithParentIds) {
                foreach ($rolesWithParentIds as $role) {
                    $roleUserData = new RoleUser();
                    $roleUserData->ref_user_id = $user->id;
                    $roleUserData->role_id = $role['role_id'];
                    $roleUserData->parent_role_id = $role['parent_role_id'];
                    $roleUserData->save();
                }
            }
            // Assign module name if applicable
            $user->module_name = ($rolesWithParentIds[0]['role_id'] ?? null) == 130
                ? 'Recruitment Portal'
                : null;
            $user->save();
            // Call notifyNewUser after creating a new user
            $this->userNotificationController->notifyNewUser(Auth::id(), $user->id);

            // Generate token and Send the reset link to the user's email
            $token = app('auth.password.broker')->createToken($user);
            try {
                Mail::to($user->email)->send(new NewUserSetPasswordMail($user, $token));
            } catch (TransportExceptionInterface $e) {
                Log::error("OTP mail send failed: " . $e->getMessage());
            }

            // 4. Notify user of success
            Alert::success('Success', "Success! We've sent an email with instructions to access user account.");

            // 5. Redirect to index route
            return redirect()->route('user-config.create');
        } catch (\Exception $e) {
            Alert::error('Error', 'Oops, something went wrong. Please try again later.');
            return redirect()->back()->withInput()->withErrors(['msg' => $e->getMessage()]);
        }
    }


    /**
     * Display the specified resource.
     */
    public function show(string $id)
    {   
        try {
            $users = User::with(['roles', 'designation', 'department'])->findOrFail(Crypt::decrypt($id));
            $hasRoles = $users->roles->pluck('id');
            $courses = RefCourse::select('id', 'course_name', "ref_qualification_id")->get();
            $qualifications = RefQualification::select('id', 'qualification_name')->get();
            $board_university_collages = RefBoardUniversityCollege::get();
            $main_subjects = RefMainSubject::get();
            $course_modes = RefCourseMode::get();
            $passing_years = RefPassingYear::orderBy('passing_year', 'desc')->get();
            $area_experties = RefAreaExperties::get();
            $job_types = RefJobType::get();
            $castes = RefCaste::get();
            $header = true;
            $sidebar = true;
            $userdata = RefApplicantPersonalDetails::where('created_by', Crypt::decrypt($id))->first();
            $education = NhidclAplicantEducationDetails::with("ref_passing_year", "board_university_college", "main_subject", "course_mode", "qualification", "course")->where('created_by', Crypt::decrypt($id))->get();
            $workdata = NhidclApplicantWorkExperienceDetails::where('created_by', Crypt::decrypt($id))->get();
            return view('user-config.show', compact('users', 'hasRoles', 'header', 'sidebar', 'courses', 'qualifications', 'board_university_collages', 'main_subjects','course_modes','passing_years', 'area_experties','job_types','userdata', 'education', 'workdata', 'castes'));
        } catch (\Exception $e) {
            Alert::error('Error', 'Invalid user ID provided.');
            return redirect()->route('user-config.index');
        }
    }

    public function profile(string $id)
    {   
        try {
            $users = User::with(['roles', 'designation', 'department'])->findOrFail(Crypt::decrypt($id));
            $hasRoles = $users->roles->pluck('id');
            $courses = RefCourse::select('id', 'course_name', "ref_qualification_id")->get();
            $qualifications = RefQualification::select('id', 'qualification_name')->get();
            $board_university_collages = RefBoardUniversityCollege::get();
            $main_subjects = RefMainSubject::get();
            $course_modes = RefCourseMode::get();
            $passing_years = RefPassingYear::orderBy('passing_year', 'desc')->get();
            $area_experties = RefAreaExperties::get();
            $job_types = RefJobType::get();
            $castes = RefCaste::get();
            $employee_type  = RefEmployeeType::orderBy('name')->get();
            $department     = DepartmentMaster::orderBy('name')->get();
            $roles          = Role::where('name', '!=', 'Super Admin')->orderBy('name')->get();
            $permissions    = Permission::orderBy('name')->get();
            $designation    = DesignationMaster::orderBy('name')->get();
            $officeTypes    = RefOfficeType::orderBy('office_type_name')->get();
            $states         = RefState::orderBy('name')->get();
            $passing_years  = RefPassingYear::orderBy('passing_year', 'desc')->get();
            $projectStates  = RefProjectState::all();
            $profileData    = NhidclEmployeePersonalDetails::where('ref_users_id', Crypt::decrypt($id))->first();
            $education      = NhidclEmployeeEducationDetails::with('qualification', 'university', 'passingyear')->where('ref_users_id', Crypt::decrypt($id))->get();
            $workdata       = NhidclEmployeeWorkExperienceDetails::where('ref_users_id', Crypt::decrypt($id))->get();
            $training       = NhidclEmployeeTrainingDetails::where('ref_users_id', Crypt::decrypt($id))->get();
            $managerQuery = User::orderBy('name')
                ->select(['id', 'name', 'email']);

            // If logged in user is Manager
            $managerQuery->whereHas('roles', function ($query) {
                $query->where('name', 'Manager');
            });
            $managers = $managerQuery->get();
            $orgData    = NhidclEmployeeOrganisationDetails::with('department')->where('ref_users_id', Crypt::decrypt($id))->first();

            $header = true;
            $userdata = RefApplicantPersonalDetails::where('created_by', Crypt::decrypt($id))->first();
            
            return view('user-config.profile', compact('users', 'hasRoles', 'header', 'courses', 'qualifications', 'board_university_collages', 'main_subjects','course_modes','passing_years', 'area_experties','job_types','userdata', 'education', 'workdata', 'castes', 'employee_type', 'designation','department', 'roles', 'profileData', 'training', 'managers', 'states', 'orgData'));
        } catch (\Exception $e) {
            Log::error("User profile error: " . $e->getMessage(), ['exception' => $e]);
            Alert::error('Error', 'Invalid user ID provided.');
            return redirect()->route('user-config.index');
        }
    }

    public function edit(string $id)
    {
        try {
            // Safely decrypt the ID
            try {
                $decryptedId = Crypt::decrypt($id);
            } catch (\Exception $e) {
                Log::warning("Invalid encrypted ID provided: {$id}");
                Alert::error('Error', 'Invalid or expired user link.');
                return redirect()->route('user-config.index');
            }

            // Find the user with roles & permissions eager loaded
            $user = User::with(['roles.permissions', 'permissions'])->find($decryptedId);

            if (!$user) {
                Alert::error('Error', 'User not found.');
                return redirect()->route('user-config.index');
            }

            // Prevent role editing for Super Admin
            if ($user->hasRole('Super Admin')) {
                Alert::error('Error', 'Roles for Super Admin cannot be edited.');
                return redirect()->route('user-config.show', $id);
            }

            // Fetch reference/master data in fewer queries
            $department     = DepartmentMaster::orderBy('name')->get();
            $roles          = Role::where('name', '!=', 'Super Admin')->orderBy('name')->get();
            $permissions    = Permission::orderBy('name')->get();
            $designation    = DesignationMaster::orderBy('name')->get();
            $employeeTypes  = RefEmployeeType::orderBy('name')->get();
            $officeTypes    = RefOfficeType::orderBy('office_type_name')->get();
            $states         = RefState::orderBy('name')->get();
            $passing_years  = RefPassingYear::orderBy('passing_year', 'desc')->get();
            $projectStates  = RefProjectState::all();

            // Collect roles & permissions
            $hasRoles          = $user->roles->pluck('id');
            $rolePermissions   = $user->roles->pluck('permissions')->flatten()->pluck('id');
            $directPermissions = $user->permissions->pluck('id');
            $hasPermissions    = $directPermissions->merge($rolePermissions)->unique();

            // Get dms approvers (with permission filter)
            $dmsApprovers = User::permission('dms-approver')
                ->where('is_nhidcl_employee', true)
                ->where('is_deleted', '!=', 1)
                ->orderBy('name')
                ->get(['id', 'name', 'email']);

            // Get bgms verifiers (with permission filter)
            $bgms_verifiers = User::permission('bgms-verifier-verify')
                ->where('is_nhidcl_employee', true)
                ->where('is_deleted', '!=', 1)
                ->orderBy('name')
                ->get(['id', 'name', 'email']);

            $authUser = Auth::user();
            $managerQuery = User::where('is_deleted', '!=', '1')
                ->orderBy('name')
                ->select(['id', 'name', 'email']);

            // If logged in user is Manager
            if ($authUser->hasRole('Manager')) {
                $managerQuery->whereHas('roles', function ($query) {
                    $query->where('name', 'General Manager');
                });
            } else {
                // For other users → only Managers
                $managerQuery->whereHas('roles', function ($query) {
                    $query->where('name', 'Manager');
                });
            }
            $manager = $managerQuery->where('id', '!=', $authUser->id)->get();
            // Pass data to view
            return view('user-config.edit', [
                'user'          => $user,
                'roles'         => $roles,
                'permissions'   => $permissions,
                'designation'   => $designation,
                'employee_type' => $employeeTypes,
                'office_type'   => $officeTypes,
                'state'         => $states,
                'passing_years' => $passing_years,
                'department'    => $department,
                'projectState'  => $projectStates,
                'hasRoles'      => $hasRoles,
                'hasPermissions'=> $hasPermissions,
                'dms_approvers' => $dmsApprovers,
                'bgms_verifiers'=> $bgms_verifiers,
                'manager'       => $manager,
                'header'        => true,
                'sidebar'       => true,
            ]);

        } catch (\Throwable $e) {
            Log::error("User edit failed: " . $e->getMessage(), ['trace' => $e->getTraceAsString()]);
            Alert::error('Error', 'Something went wrong. Please try again later.');
            return redirect()->route('user-config.index');
        }
    }


    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, string $id)
    {
        try {
            // Decrypt the user ID safely
            $decryptedId = Crypt::decrypt($id);
        } catch (\Exception $e) {
            Alert::error('Error', 'Invalid user ID provided.');
            return redirect()->route('user-config.index');
        }
        try {
            $user = User::findOrFail($decryptedId);
            // Validate only what’s required
            $validated = $request->validate([
                'is_nhidcl_employee' => 'required|in:0,1',
            ]);


            // Prepare update data (falling back to existing values)
            $updateData = array_merge([
                'name'                 => $user->name,
                'email'                => $user->email,
                'mobile'               => $user->mobile,
                'ref_department_id'    => null,
                'ref_employee_type_id' => null,
                'ref_designation_id'   => null,
                'ref_office_type_id'   => null,
                'date_of_joining'      => null,
                'is_nhidcl_employee'   => null,
                'bgms_assigned_state'  => null,
                'dms_approver_id'      => null,
                'reporting_manager_id' => null,
                'status'               => null,
            ], $request->only([
                'name', 'email', 'mobile',
                'ref_department_id', 'ref_employee_type_id', 'ref_designation_id', 'ref_office_type_id',
                'date_of_joining', 'is_nhidcl_employee', 'bgms_assigned_state',
                'dms_approver_id', 'reporting_manager_id', 'status'
            ]));

            // Adjust mapping for consistency
            $updateData['currently_posted'] = $request->state_id;
            $updateData['updated_by'] = Auth::id();

            // Update user
            $user->update($updateData);

            // Handle roles (except for Super Admin)
            if ($user->hasRole('Super Admin')) {
                Alert::info('Notice', 'Roles for Super Admin cannot be changed.');
                return redirect()->route('user-config.edit', $id)
                    ->with('success', 'Roles for Super Admin cannot be changed');
            }

            // Map roles to IDs + parent IDs
            $rolesWithParentIds = collect($request->role ?? [])
                ->map(function ($roleName) {
                    if ($role = Role::findByName($roleName)) {
                        return [
                            'role_id'        => $role->id,
                            'parent_role_id' => $role->parent_role_id,
                        ];
                    }
                    return null;
                })
                ->filter()
                ->values()
                ->toArray();

                // Sync roles + log activity
                $user->syncRolesWithLogging($rolesWithParentIds);
                $this->storePermissionsToUser($request, $user);

            // Assign module name if applicable
            $user->module_name = ($rolesWithParentIds[0]['role_id'] ?? null) == 130
                ? 'Recruitment Portal'
                : null;
            $user->save();

            (new UserActivityController())->logActivity('User roles updated successfully', $user->id);

            Alert::success('Success', 'User updated successfully');
            return redirect()->route('user-config.edit', $id)
                ->with('success', 'User updated successfully');

        } catch (\Exception $e) {
            Log::error("Error updating user: " . $e->getMessage(), ['exception' => $e]);
            Alert::error('Error', 'Oops, something went wrong. Please try again later.');
            return redirect()->route('user-config.edit', $id)
                ->withInput()
                ->withErrors(['msg' => $e->getMessage()]);
        }
    }

    public function storePermissionsToUser(Request $request, User $user)
    {
        try {
            // 1. Validate the input
            $validatedData = $request->validate([
                'permission' => 'nullable|array', // Optional field, must be an array if provided
                'permission.*' => 'string|exists:permissions,name', // Ensure every permission exists
            ]);

            // 2. Assign permissions to the user if provided
            if (!empty($validatedData['permission'])) {
                foreach ($validatedData['permission'] as $permissionName) {
                    // $user->givePermissionTo($permissionName);
                    $user->syncPermissions($validatedData['permission']);
                }
            }

            // 3. Success feedback
            return "Success";
        } catch (\Illuminate\Validation\ValidationException $e) {
            // Handle validation errors specifically
            Log::error("Validation error in storePermissionsToUser: " . $e->getMessage(), ['validation_errors' => $e->validator->errors()]);
            return "Please provide correct user and permission details.";
        } catch (\Exception $e) {
            // Handle errors gracefully
            Log::error("Error in storePermissionsToUser: " . $e->getMessage(), ['exception' => $e]);
            return "Oops, something went wrong. Please try again later.";
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(string $id)
    {
        try {
            $user = User::find(Crypt::decrypt($id));
            if (!$user) {
                Alert::error('Error', 'Something went wrong, Please try again.');
                return redirect()->back()->withInput()->withErrors(['msg' => ['Something went wrong, Please try again.']]);
            }
            $user->update(['is_deleted' => '1', 'updated_by' => Auth::user()->id]);

            $this->userNotificationController->notifyDestroyUser(Auth::id(), $user->id);

            Alert::success('Success', 'User deleted successfully');
            return redirect()->route('user-config.view')->with('success', 'User deleted successfully');
        } catch (\Exception $e) {
            Alert::error('Error', 'Oops, something went wrong. Please try again later.');
            return redirect()->back()->withInput()->withErrors(['msg' => $e->getMessage()]);
        }
    }

    /**
     * Reset password.
     */
    public function resetPassword(string $id)
    {
        try {
            $users = User::find(Crypt::decrypt($id));
            if (!$users) {
                Alert::error('Error', 'Something went wrong, Please try again.');
                return redirect()->back()->withInput()->withErrors(['msg' => ['Something went wrong, Please try again.']]);
            }
            $plainPassword = Str::random(12);  // Generate a secure password
            $encryptedPassword = bcrypt('password123');
            $users->update(['password' => $encryptedPassword, 'updated_by' => Auth::user()->id]);

            // Send the new password via email
            // Mail::send('emails.password-reset', ['user' => $users, 'password' => $plainPassword], function ($message) use ($users) {
            //     $message->to($users->email)
            //         ->subject('Your password has been reset');
            // });

            Alert::success('Success', 'New password has been sent to your registered email address.');
            return redirect()->back()->with('success', 'New password has been sent to your registered email address.');
        } catch (\Illuminate\Contracts\Encryption\DecryptException $e) {
            Alert::error('Error', 'Invalid user ID. Please try again.');
            return redirect()->back()->withErrors(['msg' => ['Invalid user ID.']]);
        } catch (\Exception $e) {
            Alert::error('Error', 'Oops, something went wrong. Please try again later.');
            return redirect()->back()->withErrors(['msg' => $e->getMessage()]);
        }
    }

    /**
     * Display list of users with edit rights.
     */
    public function view(Request $request)
    {
        // If the request is an AJAX call for DataTables
        if ($request->ajax()) {
            if ($request->has('download') && $request->download == 'excel') {
                return $this->export($request);
            }

            $users = User::where('is_deleted', '!=', '1')
                ->whereDoesntHave('roles', function ($query) {
                    $query->where('name', 'Super Admin');
                })
                ->select([
                    'id',
                    'name',
                    'email',
                    'mobile',
                    'ref_department_id',
                    'is_logged',
                    'ref_employee_type_id'
                ])
                ->with('roles'); // Eager loading roles to optimize queries
            if ($request->has('search') && $request->search != '') {
                $searchTerm = '%' . trim($request->search) . '%';

                $users->where(function ($query) use ($searchTerm) {
                    $query->whereRaw('email ILIKE ?', [$searchTerm])
                        ->orWhereRaw('mobile ILIKE ?', [$searchTerm])
                        ->orWhereRaw('name ILIKE ?', [$searchTerm]);
                });
            }

            if ($request->has('email') && $request->email != '') {
                $users->whereRaw('email ILIKE ?', ['%' . trim($request->email) . '%']);
            }

            if ($request->has('mobile') && $request->mobile != '') {
                $users->where('mobile', 'like', '%' . $request->mobile . '%');
            }

            if ($request->has('department') && $request->department != '') {
                $users->where('ref_department_id', (int)$request->department);
            }

            if ($request->has('role') && $request->role != '') {
                $users->whereHas('roles', function ($query) use ($request) {
                    $query->where('roles.id', $request->role); // Filter based on role ID
                });
            }
            $users = $users->orderBy('id', 'DESC')->get();
            
            return DataTables::of($users)
                ->addIndexColumn()
                ->addColumn('action', function ($row) {
                    $showUrl = route('user-config.show', Crypt::encrypt($row->id));
                    $editUrl = route('user-config.edit', Crypt::encrypt($row->id));
                    $profileUrl = route('user-config.profile', Crypt::encrypt($row->id));
                    $deleteUrl = route('user-config.destroy', Crypt::encrypt($row->id));

                    $actionBtn = '<a href="' . $showUrl . '" class="btn btn-info btn-sm">View</a>';

                    if (Gate::allows('user config - edit user'))
                        $actionBtn .= '<a href="' . $editUrl . '" class="btn btn-primary btn-sm">Edit</a>';
                        $actionBtn .= '<a href="' . $profileUrl . '" class="btn btn-primary btn-sm">Profile</a>';

                    if (Auth::user()->hasRole('Super Admin')) {
                        $actionBtn .= '<a href="javascript:void(0)" class="btn btn-danger btn-sm" data-id="' . Crypt::encrypt($row->id) . '" onclick="confirmDelete(\'' . $row->email . '\')">Delete</a>';
                        $actionBtn .= '<form id="delete-form-' . $row->email . '" action="' . $deleteUrl . '" method="POST" style="display: none;">' . csrf_field() . method_field('DELETE') . '</form>';
                    }
                    return $actionBtn;
                })
                ->editColumn('department_master_id', function ($row) {
                    return $row->department->name ?? '';
                    //return getDepartmentNameById($row->ref_department_id);
                })
                ->editColumn('roles', function ($row) {
                    return $row->roles->pluck('name')->implode(', ');
                })
                // ->editColumn('is_logged', function ($row) {
                //     return $row->status ?? 'NA';
                // })
                // ->editColumn('is_nhidcl_employee', function ($row) {
                //     return $row->is_nhidcl_employee ? 'Yes' : 'No';
                // })
                ->editColumn('employee_type_id', function ($row) {
                    return getEmployeeTypeNameById($row->ref_employee_type_id);
                })
                ->rawColumns(['action'])
                ->make(true);
        }

        $roles = Role::get();
        $departments = DepartmentMaster::get();

        // Render the view with the DataTables setup
        $header = TRUE;
        $sidebar = TRUE;
        return view('user-config.view', compact('header', 'sidebar', 'roles', 'departments'));
    }

    // public function view(Request $request)
    // {
    //     $users = User::where('is_deleted', '!=', '1')->orderBy('name', 'asc')->get();
    //     $header = TRUE;
    //     $sidebar = TRUE;
    //     return view('user-config.view', compact('header', 'sidebar','users'));
    // }
    public function searchUsersByRole()
    {
        // $UserId = Session::get('ref_user_id');



        //  $users = User::where('user_code', $UserId)->get();

        $users = User::whereNull('user_code')->get();
        //  $user = User::find($users->id);
        //$user = User::with(['creator', 'updater', 'roles'])->findOrFail($users->id);
        //dd($user);
        //$hasRoles = $user->roles->pluck('id');




        $rows = '';
        if ($users->isEmpty()) {
            $rows .= '<tr><td colspan="3">No users found for this role.</td></tr>';
        } else {
            foreach ($users as $user) {
                // $roles = $user->roles->pluck('name')->implode(', ');

                $rows .= "<tr>
                           <td>{$user->id}</td>
                           <td>{$user->name}</td>
                           <td>Pending</td>
                           <td>
                           <a href='" . route('user.profile', $user->id) . "' class='btn btn-info'>View Profile</a>
                           </td>
                           <td><input type='checkbox' id='selected_{$user->id}' name='selected[]' value='{$user->id}'></td>
                       </tr>";
            }
        }

        return response()->json(['html' => $rows]);  // Return rows as HTML
    }

    public function searchShortListedUsersByRole()
    {
        $UserId = Session::get('ref_user_id');

        //$users = User::where('user_code', $UserId)->get();
        $users = User::where('user_code', 5)->get();
        // dd($users);
        $rows = '';
        if ($users->isEmpty()) {
            $rows .= '<tr><td colspan="3">No users found for this role.</td></tr>';
        } else {
            foreach ($users as $user) {
                $roles = $user->roles->pluck('name')->implode(', ');
                $rows .= "<tr>
                           <td>{$user->id}</td>
                           <td>{$user->name}</td>
                           <td>Pending</td>
                           <td>
                           <a href='" . route('user.profile', $user->id) . "' class='btn btn-info'>View Profile</a>
                           </td>
                           <td><input type='checkbox' id='selected_{$user->id}' name='selected[]' value='{$user->id}'></td>
                       </tr>";
            }
        }

        return response()->json(['html' => $rows]);  // Return rows as HTML
    }

    public function updateUserStatus(Request $request)
    {
        // dd($request);

        $validated = $request->validate([
            'user_ids' => 'required|array|min:1',
            //  'user_ids.*' => 'integer|exists:ref_interview_status_id,User_id',
            //  'status' => 'required|string|in:active,inactive,suspended',
        ]);

        $userIds = $validated['user_ids'];
        // $status = $validated['status'];

        try {

            $updatedRows = NhidclUserStatus::whereIn('ref_users_id', $userIds)
                ->update(['ref_interview_status_id' => 5]);

            if ($updatedRows > 0) {
                return response()->json(['message' => 'Users\' status updated successfully']);
            } else {
                return response()->json(['message' => 'No users were updated'], 400);
            }
        } catch (\Exception $e) {

            return response()->json(['message' => 'Internal Server Error'], 500);
        }
    }

    public function showUserProfile($id)
    {

        $header = TRUE;
        $sidebar = TRUE;
        $users = User::find($id);

        if ($users) {
            return view('hr.CandidateUserData', compact('users', 'header', 'sidebar'));
        } else {
            echo "User not found.";
        }
    }

    public function export(Request $request)
    {
        $filters = $request->only(['email', 'mobile', 'department', 'role']);
        return Excel::download(new UsersExport($filters), 'users.xlsx');
    }

    public function loginHistory(Request $request)
    {
        $header = TRUE;
        $sidebar = TRUE;

        if ($request->ajax()) {
            // Start query
            $query = UserActivity::query(); // don't use latest() if DataTables handles sorting

            // Restrict for non-Super Admin users
            if (!Auth::user()->hasRole('Super Admin')) {
                $query->where('ref_users_id', Auth::user()->id);
            }

            // Apply user filter
            if ($request->filled('user_id')) {
                $query->where('ref_users_id', $request->user_id);
            }

            // Apply date range filter
            if ($request->filled('start_date') && $request->filled('end_date')) {
                $start = Carbon::parse($request->start_date)->startOfDay();
                $end = Carbon::parse($request->end_date)->endOfDay();
                $query->whereBetween('created_at', [$start, $end]);
            }

            return DataTables::of($query)
                ->addIndexColumn()

                // Users column (relationship)
                ->addColumn('users', fn($row) => $row->user->name ?? 'N/A')
                ->filterColumn('users', function ($query, $keyword) {
                    $query->whereHas('user', fn($q) => $q->where('name', 'like', "%{$keyword}%"));
                })

                // Created at column
                ->orderColumn('created_at', fn($query, $order) =>
                    $query->orderBy('nhidcl_user_activities.created_at', $order)
                )
                ->editColumn('created_at', fn($row) => $row->created_at ? $row->created_at->format('d-m-Y H:i:s A') : null)

                // Other simple columns
                ->addColumn('browser', fn($row) => $row->browser ?? 'N/A')
                ->addColumn('platform', fn($row) => $row->platform ?? 'N/A')
                ->addColumn('activity', fn($row) => $row->activity ?? 'N/A')
                ->addColumn('ip_address', fn($row) => $row->ip_address ?? 'N/A')

                ->make(true);
        }

        $users = User::all(); // For dropdown
        return view('user-config.login-history', compact('users', 'header', 'sidebar'));
    }

    public function showLogs(Request $request)
    {
        $filename = $request->get('filename', 'laravel.log');
        $path = storage_path("logs/{$filename}");

        if (!File::exists($path)) {
            abort(404, 'Log file not found');
        }

        $limit = 500; // lines per page
        $page = (int) $request->get('page', 1);

        $lines = [];
        $totalLines = 0;

        $handle = fopen($path, 'r');
        if ($handle) {
            while (($line = fgets($handle)) !== false) {
                $lines[] = $line;
                $totalLines++;
            }
            fclose($handle);
        }

        // Calculate slice for pagination
        $lines = array_slice($lines, -$limit * $page, $limit);

        return view('user-config.show-logs', [
            'content' => implode('', $lines),
            'filename' => $filename,
            'page' => $page,
            'hasMore' => $totalLines > $limit * $page
        ]);
    }


    public function clearLogs(Request $request)
    {
        $filename = $request->get('filename', 'laravel.log');
        $path = storage_path("logs/{$filename}");
        if (File::exists($path)) {
            File::put($path, ''); // Clear file
        }

        return redirect()->route('users.logs.show')->with('success', 'Log file cleared successfully.');
    }

    public function personalDetails(Request $request){
        $validator = Validator::make($request->all(), [
            'title' => 'required|string|max:5',
            'name' => 'required|string|max:255',
            'email' => 'required|email|max:100',
            'mobile' => 'required|digits:10|max:10',
            'date_of_birth' => 'required|date|before:today',
            'gender' => 'required|string',
            'blood_group' => 'required|string',
            'marital_status' => 'required|string',
            'country_of_birth' => 'required|string',
            'place_of_birth' => 'required|string',
            'religion' => 'required|string',
        ]);

        // If validation fails
        if ($validator->fails()) {
            $currentUrl = $request->fullUrl();
            $referer = $request->headers->get('referer');
            if ($referer && $referer !== $currentUrl) {
                return redirect()->back()->withErrors($validator)->withInput();
            }
        }

        $userId = $request->userid;
        // 2. Insert data after validation
        $insertData = array(
            'ref_users_id' => $userId,
            'title' => htmlspecialchars($request->title),
            'name' => htmlspecialchars($request->name),
            'email' => htmlspecialchars($request->email),
            'mobile_number' => $request->mobile,
            'alternate_mobile_number' => $request->mobile_alternate,
            'date_of_birth' => $request->date_of_birth,
            'gender' => $request->gender,
            'blood_group' => $request->blood_group,
            'marital_status' => $request->marital_status,
            'wedding_date' => $request->wedding_date,
            'country_of_birth' => $request->country_of_birth,
            'place_of_birth' => $request->place_of_birth,
            'religion' => $request->religion,
            'nationality' => $request->nationality,
            'ref_caste_id' => $request->category,
            'ex_serviceman' => $request->ex_serviceman,
            'disability' => $request->disability,
            'language' => $request->language,
            'hobbies' => $request->hobbies,
            'current_address' => $request->current_address,
            'permanent_address' => $request->permanent_address,
            'emergency_contact_name' => $request->emergency_contact_name,
            'emergency_contact_relation' => $request->emergency_contact_relation,
            'emergency_contact_mobile' => $request->emergency_contact_mobile,
            'emergency_contact_alternate_mobile' => $request->emergency_contact_mobile_alternate,
            'emergency_contact_address' => $request->emergency_contact_address,
            'nok_contact_name' => $request->nok_contact_name,
            'nok_contact_relation' => $request->nok_contact_relation,
            'nok_contact_mobile' => $request->nok_contact_mobile,
            'nok_contact_alternate_mobile' => $request->nok_contact_alternate_mobile,
            'nok_contact_address' => $request->nok_contact_address,
            'father_name' => $request->father_name,
            'father_dependent' => $request->father_dependent,
            'mother_name' => $request->mother_name,
            'mother_dependent' => $request->mother_dependent,
            'spouse_name' => $request->spouse_name,
            'spouse_dependent' => $request->spouse_dependent,
            'child_name' => $request->child_name,
            'child_dependent' => $request->child_dependent,
            'created_by' => $userId,
            'updated_by' => Auth::user()->id,
        );
        // 3. Create personal details
        NhidclEmployeePersonalDetails::updateOrCreate(
        ['ref_users_id' => $userId], // condition to match existing record
            $insertData // data to insert or update
        );
        Alert::success('Success', 'Employee personal details added successfully.');
        return redirect()->back()
            ->with('success', 'Employee personal details added successfully.');
    }
    
    public function educationDetails(Request $request){

        $validator = Validator::make($request->all(), [
            'ref_qualification_id' => 'required|integer|max:99999',
            'institute_name' => 'required|string|max:255',
            'ref_board_university_college_id' => 'required|integer',
            'passing_year' => 'required|integer',
            'percentage_cgpa' => 'required|numeric|min:0|max:100',
        ]);

        // If validation fails
        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator)
                ->withInput();
        }
        $userId = $request->userid;
        $validated = $validator->validated();
        if(!empty($request->upload_degree_txt)){
            $marksheet = extractFileDetails($request->upload_degree_txt);
            $dataArr['marksheet_certificate'] = @$marksheet["fileName"];
            $dataArr['marksheet_certificate_filepath'] = @$marksheet["filePath"];
        }
        $dataArr["ref_qualification_id"] = $validated['ref_qualification_id'];
        $dataArr["college_name"] = $validated['institute_name'];
        $dataArr["ref_board_university_college_id"] = $request->ref_board_university_college_id;
        $dataArr["ref_passing_year_id"] = $request->passing_year;
        $dataArr["marks_percentage"] = $request->percentage_cgpa;
        $dataArr['created_by'] = $userId;
        $dataArr['updated_by'] = Auth::user()->id;
        $dataArr['ref_users_id'] = $userId;
        $dataArr['created_at'] = now();
        $save = NhidclEmployeeEducationDetails::create($dataArr);

        if ($save) {
            Alert::success('Success', 'Employee education details added successfully.');
            return redirect()->back()
            ->with('success', 'Employee education details added successfully.');
        } else {
            Alert::error('Error', 'Something went wrong');
            return redirect()->back();
        }

    }

    public function workExperienceDetails(Request $request)
    {   
        $validator = Validator::make($request->all(), [
            'employer_name'      => 'required|string|max:255',
            'post_held'          => 'required|string|max:255',
            'from_date'          => 'required|date|before_or_equal:to_date',
            'to_date'            => 'required|date|after_or_equal:from_date',
            'job_description'   => 'required|string|max:500',
        ]);

        // If validation fails
        if ($validator->fails()) {
            $currentUrl = $request->fullUrl();
            $referer = $request->headers->get('referer');
            if ($referer && $referer !== $currentUrl) {
                return redirect()->back()->withErrors($validator)->withInput();
            }
        }
        try {
            if ($validator->passes()) {
                $userId = $request->userid;
                if(!empty($request->experience_certificate_txt)){
                    $marksheet = extractFileDetails($request->experience_certificate_txt);
                    $dataArr['experience_letter'] = @$marksheet["fileName"];
                    $dataArr['experience_letter_filepath'] = @$marksheet["filePath"];
                }
                $validated = $validator->validated();
                $dataArr["employer_name"] = $validated['employer_name'];
                $dataArr["post_held"] = $validated['post_held'];
                $dataArr["from_date"] = $validated['from_date'];
                $dataArr["to_date"] = $validated['to_date'];
                $dataArr["job_summary"] = $validated['job_description'];
                $dataArr['created_by'] = $userId;
                $dataArr['updated_by'] = Auth::user()->id;
                $dataArr['ref_users_id'] = $userId;
                $dataArr['created_at'] = now();
                $save = NhidclEmployeeWorkExperienceDetails::insert($dataArr);

                if ($save) {
                    Alert::success('Success', 'Work Experience added successfully');
                    return redirect()->back()
                    ->with('success', 'Employee work experience added successfully.');
                } else {
                    Alert::error('Error', 'Something went wrong.');
                    return redirect()->back()
                    ->with('success', 'Something went wrong, try again.');
                }
            }
        } catch (\Exception $e) {
            Log::error($e->getMessage());
            Alert::error('Error', 'Something went wrong.');
            return redirect()->back()
                    ->with('success', 'Something went wrong, try again.');
        }
    }

    public function trainingDetails(Request $request)
    {   
        $validator = Validator::make($request->all(), [
            'name_of_training'      => 'required|string|max:255',
            'training_start_date'          => 'required|date|before_or_equal:training_start_date',
            'training_end_date'            => 'required|date|after_or_equal:training_end_date',
            'description'          => 'required|string|max:500',
            'certificate_expiry_date' => 'required|date',
        ]);
        
        // If validation fails
        if ($validator->fails()) {
            $currentUrl = $request->fullUrl();
            $referer = $request->headers->get('referer');
            if ($referer && $referer !== $currentUrl) {
                return redirect()->back()->withErrors($validator)->withInput();
            }
        }
        
        try {
            if ($validator->passes()) {
                $userId = $request->userid;
                if(!empty($request->training_certificate_txt)){
                    $marksheet = extractFileDetails($request->training_certificate_txt);
                    $dataArr['certificate'] = @$marksheet["fileName"];
                    $dataArr['certificate_filepath'] = @$marksheet["filePath"];
                }
                $validated = $validator->validated();
                $dataArr["training_name"] = $validated['name_of_training'];
                $dataArr["start_date"] = $validated['training_start_date'];
                $dataArr["end_date"] = $validated['training_end_date'];
                $dataArr["summary"] = $validated['description'];
                $dataArr["certificate_expiry"] = $validated['certificate_expiry_date'];
                $dataArr['created_by'] = $userId;
                $dataArr['updated_by'] = Auth::user()->id;
                $dataArr['ref_users_id'] = $userId;
                $dataArr['created_at'] = now();
                $save = NhidclEmployeeTrainingDetails::insert($dataArr);

                if ($save) {
                    Alert::success('Success', 'Employee Training Deatils added successfully');
                    return redirect()->back()
                    ->with('success', 'Employee Training Deatils added successfully.');
                } else {
                    Alert::error('Error', 'Something went wrong.');
                    return redirect()->back()
                    ->with('success', 'Something went wrong, try again.');
                }
            }
        } catch (\Exception $e) {
            Log::error($e->getMessage());
            Alert::error('Error', 'Something went wrong.');
            return redirect()->back()
                    ->with('success', 'Something went wrong, try again.');
        }
    }

    public function documentUpload(Request $request)
    {   
        // $validator = Validator::make($request->all(), [
        //     'name_of_training'      => 'required|string|max:255',
        //     'training_start_date'          => 'required|date|before_or_equal:training_start_date',
        //     'training_end_date'            => 'required|date|after_or_equal:training_end_date',
        //     'description'          => 'required|string|max:500',
        //     'certificate_expiry_date' => 'required|date',
        // ]);
        
        // // If validation fails
        // if ($validator->fails()) {
        //     $currentUrl = $request->fullUrl();
        //     $referer = $request->headers->get('referer');
        //     if ($referer && $referer !== $currentUrl) {
        //         return redirect()->back()->withErrors($validator)->withInput();
        //     }
        // }
        
        try {
            //if ($validator->passes()) {
                $userId = $request->userid;
                if(!empty($request->upload_profile_txt)){
                    $profilePhoto = extractFileDetails($request->upload_profile_txt);
                    $dataArr['upload_photo'] = @$profilePhoto["fileName"];
                    $dataArr['upload_photo_filepath'] = @$profilePhoto["filePath"];
                }
                if(!empty($request->upload_signature_txt)){
                    $profileSignature = extractFileDetails($request->upload_signature_txt);
                    $dataArr['upload_signature'] = @$profileSignature["fileName"];
                    $dataArr['upload_signature_filepath'] = @$profileSignature["filePath"];
                }
                if(!empty($request->upload_dob_proof_txt)){
                    $dobProof = extractFileDetails($request->upload_dob_proof_txt);
                    $dataArr['upload_dob_certificate'] = @$dobProof["fileName"];
                    $dataArr['upload_dob_certificate_filepath'] = @$dobProof["filePath"];
                }
                if(!empty($request->upload_resume_txt)){
                    $resumeFile = extractFileDetails($request->upload_resume_txt);
                    $dataArr['upload_resume'] = @$resumeFile["fileName"];
                    $dataArr['upload_resume_filepath'] = @$resumeFile["filePath"];
                }
                if(!empty($request->upload_pancard_txt)){
                    $pancardFile = extractFileDetails($request->upload_pancard_txt);
                    $dataArr['upload_pancard'] = @$pancardFile["fileName"];
                    $dataArr['upload_pancard_filepath'] = @$pancardFile["filePath"];
                }
                if(!empty($request->upload_aadhar_txt)){
                    $aadharFile = extractFileDetails($request->upload_aadhar_txt);
                    $dataArr['upload_aadhar'] = @$aadharFile["fileName"];
                    $dataArr['upload_aadhar_filepath'] = @$aadharFile["filePath"];
                }
                if(!empty($request->upload_address_txt)){
                    $addressFile = extractFileDetails($request->upload_address_txt);
                    $dataArr['upload_address_proof'] = @$addressFile["fileName"];
                    $dataArr['upload_address_proof_filepath'] = @$addressFile["filePath"];
                }
                if(!empty($request->upload_caste_certificate_txt)){
                    $casteFile = extractFileDetails($request->upload_caste_certificate_txt);
                    $dataArr['upload_caste_certificate'] = @$casteFile["fileName"];
                    $dataArr['upload_caste_certificate_filepath'] = @$casteFile["filePath"];
                }
                
                $dataArr['created_at'] = now();
                NhidclEmployeePersonalDetails::updateOrCreate(
                ['ref_users_id' => $userId], // condition to match existing record
                    $dataArr // data to insert or update
                );
                Alert::success('Success', 'Employee document upload successfully.');
                return redirect()->back()
                    ->with('success', 'Employee document upload successfully.');
            //}
        } catch (\Exception $e) {
            Log::error($e->getMessage());
            Alert::error('Error', 'Something went wrong.');
            return redirect()->back()
                    ->with('success', 'Something went wrong, try again.');
        }
    }

    public function organisationUpadte(Request $request){
        $validator = Validator::make($request->all(), [
            'user_type'   => 'required|integer',
            'official_email' => 'required',
            'ref_employee_type_id' => 'required',
            'date_of_joining' => 'required|date',
            'ref_designation_id' => 'required',
            'ref_department_id' => 'required',
            'user_code' => 'required',
            'level_id' => 'required',
            'probation_period' => 'required',
            'confirmation_date' => 'required|date',
            'reporting_officer_id' => 'required',
            'ref_posting_location_id' => 'required',
        ]);
        
        // If validation fails
        if ($validator->fails()) {
            $currentUrl = $request->fullUrl();
            $referer = $request->headers->get('referer');
            if ($referer && $referer !== $currentUrl) {
                return redirect()->back()->withErrors($validator)->withInput();
            }
        }
        
        try {
            if ($validator->passes()) {
                $userId = $request->userid;
                if(!empty($request->upload_salary_slip_txt)){
                    $salarySlip = extractFileDetails($request->upload_salary_slip_txt);
                    $dataArr['salary_slip'] = @$salarySlip["fileName"];
                    $dataArr['salary_slip_filepath'] = @$salarySlip["filePath"];
                }
                if(!empty($request->upload_offer_letter_txt)){
                    $offerLetterFile = extractFileDetails($request->upload_offer_letter_txt);
                    $dataArr['offer_letter'] = @$offerLetterFile["fileName"];
                    $dataArr['offer_letter_filepath'] = @$offerLetterFile["filePath"];
                }
                if(!empty($request->upload_nda_agreement_txt)){
                    $ndaFile = extractFileDetails($request->upload_nda_agreement_txt);
                    $dataArr['nda_agreement'] = @$ndaFile["fileName"];
                    $dataArr['nda_agreement_filepath'] = @$ndaFile["filePath"];
                }
                if(!empty($request->upload_background_verification_txt)){
                    $bgVerifyFile = extractFileDetails($request->upload_background_verification_txt);
                    $dataArr['bg_verfication_report'] = @$bgVerifyFile["fileName"];
                    $dataArr['bg_verfication_report_filepath'] = @$bgVerifyFile["filePath"];
                }
                if(!empty($request->upload_disciplinary_status_txt)){
                    $disciplinaryFile = extractFileDetails($request->upload_disciplinary_status_txt);
                    $dataArr['disciplinary_report'] = @$disciplinaryFile["fileName"];
                    $dataArr['disciplinary_report_filepath'] = @$disciplinaryFile["filePath"];
                }
                if(!empty($request->upload_vigilance_clearance_txt)){
                    $vigilanceFile = extractFileDetails($request->upload_vigilance_clearance_txt);
                    $dataArr['vigilance_report'] = @$vigilanceFile["fileName"];
                    $dataArr['vigilance_report_filepath'] = @$vigilanceFile["filePath"];
                }
                if(!empty($request->upload_medical_fitness_txt)){
                    $medicalFile = extractFileDetails($request->upload_medical_fitness_txt);
                    $dataArr['medical_report'] = @$medicalFile["fileName"];
                    $dataArr['medical_report_filepath'] = @$medicalFile["filePath"];
                }
                if(!empty($request->upload_marriage_certificate_txt)){
                    $marriageFile = extractFileDetails($request->upload_marriage_certificate_txt);
                    $dataArr['marriage_certificate'] = @$marriageFile["fileName"];
                    $dataArr['marriage_certificate_filepath'] = @$marriageFile["filePath"];
                }
                $validated = $validator->validated();
                $dataArr["user_type"] = $validated['user_type'];
                $dataArr["official_email"] = $validated['official_email'];
                $dataArr["ref_employee_type_id"] = $validated['ref_employee_type_id'];
                $dataArr["date_of_joining"] = $validated['date_of_joining'];
                $dataArr["ref_designation_id"] = $validated['ref_designation_id'];

                $dataArr["ref_department_id"] = $validated['ref_department_id'];
                $dataArr["employee_id"] = $validated['user_code'];
                $dataArr["present_level"] = $validated['level_id'];
                $dataArr["probation_period"] = $validated['probation_period'];
                $dataArr["confirmation_date"] = $validated['confirmation_date'];
                $dataArr["ref_users_id_reporting_officer"] = $validated['reporting_officer_id'];
                $dataArr["posting_location"] = $validated['ref_posting_location_id'];
                $dataArr['created_by'] = $userId;
                $dataArr['updated_by'] = Auth::user()->id;
                $dataArr['ref_users_id'] = $userId;
                $dataArr['created_at'] = now();

                NhidclEmployeeOrganisationDetails::updateOrCreate(
                ['ref_users_id' => $userId], // condition to match existing record
                    $dataArr // data to insert or update
                );
                Alert::success('Success', 'Employee organisation details update successfully.');
                return redirect()->back()
                    ->with('success', 'Employee organisation details update successfully.');
            }
        } catch (\Exception $e) {
            Log::error($e->getMessage());
            Alert::error('Error', 'Something went wrong.');
            return redirect()->back()
                    ->with('success', 'Something went wrong, try again.');
        }
        
    }

    public function profileSubmit(Request $request){
        $userId = $request->userid;
        $dataArr['profile_status'] = 'submit';
        $dataArr['updated_by'] = Auth::user()->id;
        $dataArr['updated_at'] = now();
        NhidclEmployeePersonalDetails::updateOrCreate(
        ['ref_users_id' => $userId], // condition to match existing record
            $dataArr // data to insert or update
        );
        $message = "Employee profile approved via ".Auth::user()->name.", ".Auth::user()->email;
        Log::info($message);
        Alert::success('Success', 'Employee profile approved successfully.');
        return redirect()->back()
            ->with('success', 'Employee profile approved successfully.');
    }
}   
