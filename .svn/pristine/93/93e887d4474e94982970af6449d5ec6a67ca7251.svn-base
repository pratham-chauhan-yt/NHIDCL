<?php

namespace App\Http\Controllers\TrainingManagement;

use App\Models\User;
use App\Http\Controllers\Controller;
use App\Models\TrainingManagement\{TrainingSession,TrainingAttendee,TrainingRequest};

class AttendeeController extends Controller
{

    public function __construct()
    {
        $this->middleware('auth');
    }

    public function dashboard()
    {
        $header = true;
        $sidebar = true;
        $user = auth()->user();

        $enrolledCount = TrainingAttendee::where('ref_users_id', $user->id)->count();
        
        // Completed sessions
        $completedCount = TrainingAttendee::where('ref_users_id', $user->id)->whereHas('status', function ($query) {
            $query->where('type', 'Pending'); // Replace 'status_name' with the actual column name in ref_status table
            $query->where('status_type', 'training budget');
        })->count();
        
        // Ongoing sessions (join with training + trainer)
        $ongoingSessions = TrainingSession::with('trainer.user', 'status')
            ->whereHas('status', function ($query) {
                $query->where('type', 'Ongoing'); // Replace 'status_name' with the actual column name in ref_status table
                $query->where('status_type', 'training sessions');
            })
            ->whereHas('attendees', function ($query) use ($user) {
                $query->where('ref_users_id', $user->id);
            })
            ->get();
        $totalTrainers = User::role('Trainer')->count();
        $sessionsCount = TrainingSession::count();
        $requestCount = TrainingRequest::where('ref_users_id', $user->id)->count();
        return view("training-management.employee.dashboard", compact("header", "sidebar", "enrolledCount", "completedCount", "ongoingSessions", "totalTrainers", "sessionsCount", "requestCount"));
    }

}
