<?php

use Illuminate\Support\Facades\Route;
use Illuminate\Support\Facades\Auth;
use App\Http\Controllers\Auth\{EmailController, LoginController,RecruitmentLoginController};
use App\Http\Controllers\Auth\ForgotPasswordController;
use App\Http\Controllers\UserActivityController;
use App\Http\Controllers\Admin\{DashboardController,UserController};
use App\Http\Controllers\Admin\HrSettings\HrSettingsController;
use App\Http\Controllers\Notification\NotificationController;
use App\Http\Controllers\{Controller, CaptchaController, PermissionController,RoleController,ProfileController,OtpController};
use App\Http\Controllers\Auth\{CandidateLoginController,RegistrationController,ResetPasswordController,TwoFactorController};
use Illuminate\Support\Facades\Artisan;


require __DIR__ . '/empuser.php';

require __DIR__ . '/recruitment.php';
require __DIR__ . '/sms-template.php';
require __DIR__ . '/payment.php';

/*
|--------------------------------------------------------------------------
// Web Routes
|--------------------------------------------------------------------------
// Here is where you can register web routes for your application. These
| routes are loaded by the RouteServiceProvider and all of them will
| be assigned to the "web" middleware group. Make something great!
*/

Route::get('/clear-all', function () {
    Artisan::call('optimize:clear');
    return '<h1>Clear all</h1>';
});

//Route::get('/send/recruitment/notifications/users', [EmailController::class, 'recruitmentNotification'])->name('recruitment.notifactions.users');

// Auth routes
Auth::routes();

Route::get('/', function () {
    session()->forget(['moduleName', 'moduleHeading']);
    if (auth()->check()) {
        return redirect()->route('admin.dashboard');
    }
    // If not logged in, redirect to login route
    return redirect()->route('recruitment.login');
})->name('home'); // home route

Route::prefix('recruitment-portal')->middleware(['no.cache', 'secure.headers'])->group(function () {
    Route::get('/login', [RecruitmentLoginController::class, 'recruitmentLogin'])->name('recruitment.login');
    Route::post('/login', [RecruitmentLoginController::class, 'login'])->name('recruitment.auth.login');
    Route::post('logout', [RecruitmentLoginController::class, 'logout'])->name('recruitment.logout');
    Route::get('/help/desk', [Controller::class, 'recruitmentHelpDesk'])->name('recruitment.help.desk');
    Route::view('/faqs', 'recruitment-management.faq')->name('recruitment.faqs');

    Route::middleware(['no.cache', 'secure.headers'])->group(function () {
        Route::get('/two-factor', [RecruitmentLoginController::class, 'twoFactorIndex'])->name('recruitment.twoFactor.index');
        Route::post('/two-factor-verify', [RecruitmentLoginController::class, 'otpVerify'])
            ->middleware('throttle:otp-verify')
            ->name('recruitment.twoFactor.verify');
    });

    Route::get('password/request', [RecruitmentLoginController::class, 'showLinkRequestForm'])->name('recruitment.password.request');
    Route::post('/password/email', [RecruitmentLoginController::class, 'sendResetLinkEmail'])
        ->middleware('throttle:password-email-daily')
        ->name('recruitment.password.email');
    Route::get('password/reset/{token}', [RecruitmentLoginController::class, 'showResetForm'])->name('recruitment.password.reset');
    Route::post('password/reset', [RecruitmentLoginController::class, 'reset'])->name('recruitment.password.update');

    Route::group(["prefix" => "candidate/account"], function () {
        Route::get('/registration', [RecruitmentLoginController::class, 'registration'])->name('recruitment.auth.registration');
        Route::post('/registration', [RecruitmentLoginController::class, 'store'])->name('recruitment.auth.registration.store');
    });

    Route::get('/run-update-status', function () {
        Artisan::call('applications:update-status');
        return response()->json([
            'message' => 'Application status update command executed successfully.',
            'output' => Artisan::output()
        ]);
    });
});

Route::get('/help/desk', [Controller::class, 'helpDesk'])->name('help.desk');

//Candidate Registration routes
Route::get('password/create-password', [RegistrationController::class, 'createPassword'])->name('password.create-password');

Route::get('auth/hr', [CandidateLoginController::class, 'hr'])->name('auth.hr');
Route::post('auth/loginPost', [CandidateLoginController::class, 'loginPost'])->name('auth.loginPost'); // Change route to '/login' for clarity

// Login routes
Route::group(["prefix" => "candidate/account"], function () {
    Route::get('/registration', [RegistrationController::class, 'registration'])->name('auth.registration');
    Route::post('/registration', [RegistrationController::class, 'store'])->name('auth.registration.store');
});

Route::post('/login', [LoginController::class, 'login'])->name('auth.login');
Route::post('logout', [LoginController::class, 'logout'])->name('logout');


Route::view('/faqs', 'resource-pool.faq')->name('faqs');
Route::view('recruitment-management/faqs', 'recruitment-management.faq')->name('recruitment-management.faqs');


// Two-Factor Authentication routes
Route::middleware(['no.cache', 'secure.headers'])->group(function () {
    Route::get('/two-factor', [TwoFactorController::class, 'index'])->name('twoFactor.index');
    Route::post('/two-factor-verify', [TwoFactorController::class, 'otpVerify'])
        //->middleware('throttle:otp-verify')
        ->name('twoFactor.verify');
});

// User activity route
Route::get('/user-activities', [UserActivityController::class, 'index'])->name('user.activities');

// Password Reset Routes
Route::get('password/request', [ForgotPasswordController::class, 'showLinkRequestForm'])->name('password.request');
Route::post('/password/email', [ForgotPasswordController::class, 'sendResetLinkEmail'])
    ->middleware('throttle:password-email-daily')
    ->name('password.email');
Route::get('password/reset/{token}', [ResetPasswordController::class, 'showResetForm'])->name('password.reset');
Route::post('password/reset', [ResetPasswordController::class, 'resetFormPassword'])->name('password.update');


// Route to refresh the captcha
Route::get('/refresh-captcha', function () {
    $captchaSrc = captcha_src('flat'); // Generate captcha image source
    return response()->json(['captcha' => $captchaSrc]);
})->name('auth.refresh-captcha');

// Route to create captcha
Route::get('captcha/{config?}', [CaptchaController::class, 'create'])
    ->name('captcha')
    ->middleware('web');

// Route to generate and return audio captcha
// Route::get('/captcha/audio/inverse', [CaptchaController::class, 'audio'])
//     ->name('captcha.audio');


// Authenticated routes
Route::middleware(['auth', 'twofactor', 'single.device', 'no.cache', 'secure.headers'])->group(function () {
    Route::get('/notifications', [NotificationController::class, 'allNotifications'])->name('notifications.all');
    Route::get('/notification/read/{id}', [NotificationController::class, 'markAsRead'])->name('notification.read');
    Route::post('/notifications/mark-all-as-read', [NotificationController::class, 'markAllAsRead'])->name('notifications.markAllAsRead');
    Route::get('/notifications/unread', function () {
        $notifications = auth()->user()->unreadNotifications()->get()->map(function ($notification) {
            $notification->formatted_created_at = $notification->created_at->diffForHumans();
            return $notification;
        });

        return response()->json($notifications);
    })->name('notifications.unread');

    Route::get('dashboard', [DashboardController::class, 'index'])->middleware(['auth', 'module.permission:dashboard'])->name('admin.dashboard');
    Route::get('resource-pool-portal/hr/dashboard', [DashboardController::class, 'index'])->name('hr.dashboard');

    Route::get('user-config/view', [UserController::class, 'view'])->name('user-config.view');
    Route::put('user-config/reset-password/{id}', [UserController::class, 'resetPassword'])->name('user-config.resetPassword');
    Route::resource('user-config', UserController::class);
    Route::get('user-export', [UserController::class, 'export'])->name('users.export');
    Route::put('/user-data/{id}', [UserController::class, 'updateData'])->name('user.update-data');
    Route::get('user/login-history', [UserController::class, 'loginHistory'])->name('user.login.history');

    Route::get('profile/{id}', [ProfileController::class, 'index'])->name('profile');
    Route::post('profile-update', [ProfileController::class, 'profile_update'])->name('profile.update');
    Route::post('password/backend/reset', [ProfileController::class, 'resetBackend'])
        //->middleware('throttle:password-backend-email-daily')
        ->name('password.backend.update');
    Route::get('change-password/{id}', [ProfileController::class, 'changePassword'])->name('change-password');
});

//Mobile OTP Send
Route::post("send-otp", [OtpController::class, 'sendOtp'])->name('sendOtp');
Route::post("verify-otp", [OtpController::class, 'verifyOtp'])->name('verifyOtp');