<?php

namespace App\Http\Controllers\TrainingManagement;

use App\Models\User;
use Carbon\Carbon;
use Exception;
use Illuminate\Http\Request;
use RealRashid\SweetAlert\Facades\Alert;
use Yajra\DataTables\Facades\DataTables;
use App\Http\Requests\GrievanceRequest;
use App\Models\{Grievance,DesignationMaster,RefQualification};
use App\Http\Controllers\Controller;
use App\Models\TrainingManagement\{TrainingSession, TrainingBudget, Trainer};

class TrainerController extends Controller
{

    public function __construct()
    {
        $this->middleware('auth');
        // $this->middleware('module.permission:grievance-list')->only(['index']);
        // $this->middleware('module.permission:grievance-create')->only(['create', 'store']);
        // $this->middleware('module.permission:grievance-edit')->only(['edit', 'update']);
        // $this->middleware('module.permission:grievance-view')->only(['show']);
        // $this->middleware('module.permission:grievance-delete')->only(['destroy']);
    }

    public function index()
    {
        $userId = auth()->id();
        $header = TRUE;
        $sidebar = TRUE;
        $sessionsCount = TrainingSession::where('nhidcl_ems_trainers_id', $userId)->count();
        $completedSessions = TrainingSession::where('nhidcl_ems_trainers_id', $userId)->where('ref_status_id', '4')->count();
        $pendingBudgets = TrainingBudget::where('nhidcl_ems_trainers_id', $userId)->where('ref_status_id', '1')->count();

        $upcomingSessions = TrainingSession::where('nhidcl_ems_trainers_id', $userId)
            ->whereDate('date', '>=', now())
            ->withCount('attendees')
            ->take(10)
            ->get();

        return view('training-management.trainer.dashboard', compact('header', 'sidebar', 'sessionsCount', 'completedSessions', 'pendingBudgets', 'upcomingSessions'));
    }

    public function sessions()
    {
        $sessions = TrainingSession::where('trainer_id', auth()->id())->get();
        return view('trainer.sessions.index', compact('sessions'));
    }

    public function profile()
    {
        $header = TRUE;
        $sidebar = TRUE;
        $userId = auth()->id();
        $userprofile = Trainer::firstOrCreate(
            ['ref_users_id' => $userId],
            ['designation' => '', 'qualification' => '', 'availability' => []]
        );
        $daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        $designation = DesignationMaster::all();
        $qualification = RefQualification::all();
        return view('training-management.trainer.profile',compact('header', 'sidebar', 'userprofile', 'daysOfWeek', 'designation', 'qualification'));
    }

    public function updateProfile(Request $request)
    {   
        $userId = auth()->id();
        $request->validate([
            'ref_designation_id' => 'required|exists:ref_designation,id',
            'ref_qualification_id' => 'required|exists:ref_qualification,id',
            'availability' => 'required|array',
            'availability.*.from' => 'nullable|date_format:H:i',
            'availability.*.to' => 'nullable|date_format:H:i|after:availability.*.from',
            'amount' => 'required|numeric|min:0',
        ]);

        $trainer = Trainer::where('ref_users_id', $userId)->firstOrFail();
        $trainer->update([
            'ref_designation_id' => $request->ref_designation_id,
            'ref_qualification_id' => $request->ref_qualification_id,
            'availability' => $request->availability, // day-wise data
            'cost_per_session' => $request->amount, // day-wise data
            'updated_by' => $userId,
        ]);
        Alert::success('Success', 'Profile and availability updated successfully!');
        return redirect()->route('trainer.profile')->with('success', 'Profile and availability updated successfully!');
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        $header = true;
        $sidebar = true;
        $user_responders = User::select("id", "name", "email")
            ->where(function ($query) {
                $query->whereHas('roles', function ($subQuery) {
                    $subQuery->whereIn('name', ['MD-DRO', 'MD-RA']);
                });
            })
            //->where('is_nhidcl_employee', true)
            ->get();



        return view("trainer.create", compact("header", "sidebar", 'user_responders'));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(GrievanceRequest $request)
    {
        try {

            $inputs = $request->all();

            $grievance = Grievance::create([
                'name' => $inputs['name'],
                'employee_no' => $inputs['employee_no'],
                'ref_designation_id' => $inputs['ref_designation_id'],
                'grievance_reason' => $inputs['grievance_reason'],
                'pay_scale' => $inputs['pay_scale'],
                'ref_department_id' => $inputs['ref_department_id'],
                'permanent_address' => $inputs['permanent_address'],
                'date' => $inputs['date'],
                "created_by" => user_id(),
                "created_at" => now()
            ]);

            Alert::success('Success', 'Grievance created successfully');
            return redirect()->route("trainer.index");
        } catch (Exception $e) {
            return redirect()->route("trainer.index")->with("error", $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(string $id) {}


    /**
     * Show the form for editing the specified resource.
     */
    public function edit(string $id)
    {
        try {
            $sidebar = True;
            $header = True;
            $grievance = Grievance::findOrFail(decryptId($id));
            return view('trainer.edit', compact('grievance', 'header', 'sidebar'));
        } catch (\Exception $e) {
            Alert::error('Error', 'Invalid data provided.');
            return redirect()->route('trainer.index');
        }
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(GrievanceRequest $request, $id)
    {
        try {

            $grievance = Grievance::findOrFail(decryptId($id));

            $data = $request->validated();
            $data['updated_by'] = user_id();
            $data['updated_at'] = now();

            $grievance->update($data);

            Alert::success('Success', 'Grievance updated successfully');

            return redirect()->route('trainer.index');
        } catch (\Exception $e) {
            Alert::error('Error', 'Oops, something went wrong. Please try again later.');
            return redirect()->route('trainer.index');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(string $id)
    {

        try {

            $grievance = Grievance::find(decryptId($id));

            if (!$grievance) {
                Alert::error('Error', 'Something went wrong, Please try again.');
                return redirect()->route('trainer.index');
            }

            $grievance->is_deleted = true;

            $grievance->delete();

            Alert::success('Success', 'Grievance deleted successfully');

            return redirect()->route('trainer.index');
        } catch (\Exception $e) {
            Alert::error('Error', $e->getMessage());
            return redirect()->route('trainer.index');
        }
    }
}
