<?php

namespace App\Http\Controllers\QueryManagement;

use App\Http\Requests\DocumentManagement\ShareRequest;
use App\Models\User;
use App\Services\FileService;
use Carbon\Carbon;
use DB;
use Exception;
use Illuminate\Http\Request;
use RealRashid\SweetAlert\Facades\Alert;
use Yajra\DataTables\Facades\DataTables;
use Illuminate\Support\Str;
use App\Http\Controllers\Controller;
use App\Models\NhidclApplicationStatus;
use App\Models\QueryManagement\QmsKnowledgeBase;
use App\Models\QueryManagement\QmsQueryDetails;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Crypt;
use Illuminate\Support\Facades\Validator;

class QueryKnowledgeController extends Controller
{

    public function __construct()
    {
        $this->middleware('auth');
        $this->middleware(['permission:qms-dashboard|qms-add-query|qms-knowladge-base-query|qms-raised-query'])
            ->only(['create', 'store', 'index', 'show', 'destroy']);
        $this->middleware(function ($request, $next) {
            session(['moduleName' => 'Query Management System']);
            return $next($request);
        });
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create(Request $request)
    {
        if ($request->ajax()) {
            $query = QmsKnowledgeBase::with(['createdBy:id,name,email']);
            if (!$request->has('order')) {
                $query->orderBy('id', 'desc');
            }
            return DataTables::of($query)
                ->addIndexColumn()
                ->addColumn('description', function ($row) {
                    $plainText = e(strip_tags($row->description));
                    $truncated = strlen($plainText) > 50
                        ? substr($plainText, 0, 50) . '...'
                        : $plainText;
                    return '<span class="truncated-msg">' . $truncated . '</span> <a href="#" class="show-more underline text-fg-brand ms-1">show more</a>';
                })
                ->addColumn('full_message', function ($row) {
                    return $row->description;
                })
                ->addColumn('action', function ($row) {
                    $viewRoute = route('qms.view-knowledge-base-query', Crypt::encrypt($row->id));
                    $editRoute = route('qms.edit-knowledge-base-query', Crypt::encrypt($row->id));
                    $actions = '<a href="#" class="btn btn-sm btn-info copyViewURL me-1" data-url="' . $viewRoute . '">Copy</a>';
                    $actions .= '<a href=" ' . $viewRoute . '" class="btn btn-sm btn-primary">View</a>';
                    if (auth()->user()->can('qms-edit-knowledge-base-query')) {
                        $actions .= '<a href="' . $editRoute . '" class="btn btn-sm btn-warning">Edit</a>';
                    }
                    return $actions;
                })
                ->rawColumns(['description', 'action'])
                ->make(true);
        }
        $header = true;
        $sidebar = true;
        return view("query-management.knowledge-base-query", compact("header", "sidebar"));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        try {
            $validated = $request->validate([
                'title' => 'required|string|max:200',
                'description' => 'required|string|max:10000',
                'upload_doc_url' => 'nullable|string'
            ]);

            $replyFile = null;
            if (!empty($request->upload_doc_url)) {
                $doc = extractFileDetails($request->upload_doc_url);
                $replyFile = $doc["fileName"] ?? null;
            }

            // $cleanHtml = Purifier::clean($validated['description'], [
            //     'HTML.Trusted' => true,
            //     'CSS.AllowTricky' => true,
            //     'Attr.AllowedClasses' => null,
            //     'Attr.EnableID' => true,
            //     // Allow iframe, embed, and object tags safely, if needed
            //     'HTML.SafeEmbed' => true,
            //     'HTML.SafeObject' => true,
            //     'Output.FlashCompat' => true,
            //     'HTML.SafeIframe' => true,
            //     'URI.SafeIframeRegexp' => '#.*#',  // allow any iframe source
            // ]);

            $knowledgeBase = QmsKnowledgeBase::create([
                'title' => $validated['title'],
                'description' => $validated['description'],
                'image' => $replyFile,
                'created_by' => user_id(),
            ]);

            // Generate Reference ID: QMS-KB-YY-XX
            $knowledgeBase->update([
                'query_id' => sprintf(
                    'QMS-KB-%s-%s',
                    now()->format('y'),
                    $knowledgeBase->id
                )
            ]);
            Alert::success('Success', 'Knowledge base has been appended successfully');

            return redirect()->route('qms.knowledge-base-query');
        } catch (\Exception $e) {
            Alert::error('Error', $e->getMessage());
            return redirect()->route('qms.knowledge-base-query')->withInput();
        }
    }

    public function view($id)
    {
        $kbId = Crypt::decrypt($id);
        $data = QmsKnowledgeBase::with(['createdBy:id,name,email', 'updatedBy:id,name,email'])->where('id', $kbId)->first();
        $header = true;
        $sidebar = true;
        return view("query-management.view-knowledgebase-query", compact("header", "sidebar", "data"));
    }

    public function edit($id)
    {
        $kbId = Crypt::decrypt($id);
        $data = QmsKnowledgeBase::with(['createdBy:id,name,email'])->where('id', $kbId)->first();
        $header = true;
        $sidebar = true;
        return view("query-management.edit-knowledge-base-query", compact("header", "sidebar", "data"));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function update(string $id, Request $request)
    {
        try {
            $kbId = Crypt::decrypt($id);
            $knowladgebaseQuery = QmsKnowledgeBase::findOrFail($kbId);
            $validated = $request->validate([
                'title' => 'required|string|max:200',
                'description' => 'required|string|max:10000',
                'upload_doc_url' => 'nullable|string'
            ]);

            $replyFile = null;
            if (!empty($request->upload_doc_url)) {
                $doc = extractFileDetails($request->upload_doc_url);
                $replyFile = $doc["fileName"] ?? null;
            }

            $knowladgebaseQuery->update([
                'title' => $validated['title'],
                'description' => $validated['description'],
                'image' => $replyFile,
                'updated_by' => user_id(),
            ]);

            Alert::success('Success', 'Knowledge base query with ID ' . $knowladgebaseQuery->query_id . ' has been updated successfully');
            return redirect()->route('qms.edit-knowledge-base-query', Crypt::encrypt($knowladgebaseQuery->id));
        } catch (\Exception $e) {
            Alert::error('Error', $e->getMessage());
            return redirect()->route('qms.edit-knowledge-base-query', $id)->withInput();
        }
    }
}
