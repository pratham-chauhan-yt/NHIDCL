<?php

namespace App\Http\Controllers\QueryManagement;

use Exception;
use Illuminate\Http\Request;
use RealRashid\SweetAlert\Facades\Alert;
use Yajra\DataTables\Facades\DataTables;
use Illuminate\Support\Facades\Crypt;
use Illuminate\Support\Str;
use App\Http\Controllers\Controller;
use App\Models\NhidclApplicationStatus;
use App\Models\QueryManagement\QmsQueryDetails;
use App\Models\QueryManagement\QmsQueryReply;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;

class QueryReplyController extends Controller
{

    public function __construct()
    {
        $this->middleware('auth');
        $this->middleware(['permission:qms-dashboard|qms-add-query|qms-knowladge-base-query|qms-raised-query'])
            ->only(['create', 'store', 'index', 'show', 'destroy']);
        $this->middleware(function ($request, $next) {
            session(['moduleName' => 'Query Management System']);
            return $next($request);
        });
    }
    public $path = 'uploads/qms-reply-file/';


    /**
     * Show the form for creating a new resource.
     */
    public function queryDetails($queryId, Request $request)
    {
        if ($request->ajax()) {
            $id = Crypt::decryptString($queryId);
            $query = QmsQueryReply::with(['createdBy:id,name,email'])->where('nhidcl_qms_query_details_id', $id)->orderBy('id', 'desc');
            return DataTables::of($query)
                ->addIndexColumn()
                ->addColumn('message', function ($row) {
                    $plainText = e(strip_tags($row->message));
                    $truncated = strlen($plainText) > 50
                        ? substr($plainText, 0, 50) . '...'
                        : $plainText;
                    return '<span class="truncated-msg">' . $truncated . '</span> <a href="#" class="show-more underline text-fg-brand ms-1">show more</a>';
                })
                ->addColumn('full_message', function ($row) {
                    return $row->message;
                })
                ->addColumn('replied_by', function ($row) {
                    return $row->createdBy ? $row->createdBy->name . '<br>(' . $row->createdBy->email . ')' : '-';
                })
                ->addColumn('replied_date', function ($row) {
                    return $row->created_at ? $row->created_at->format('d M Y') : '-';
                })
                ->addColumn('file', function ($row) {
                    if (!empty($row->file)) {
                        $filePath = 'uploads/qms-reply-file/';
                        $fileName = basename($row->file);
                        $fileUrl = route('qms.view-file', [
                            'pathName' => $filePath,
                            'fileName' => $fileName,
                        ]);

                        return '<a href="' . $fileUrl . '" target="_blank" title="View File">
                                    <i class="fa fa-file-pdf mx-1 text-lg" aria-hidden="true"></i>
                                </a>';
                    } else {
                        return '-';
                    }
                })
                ->rawColumns(['replied_by', 'file', 'message'])
                ->make(true);
        }
        $header = true;
        $sidebar = true;
        $id = decrypt($queryId);
        $queryDetails = QmsQueryDetails::with(['createdBy:id,name,email', 'status:id,status', 'queryType:id,query_type'])->where('id', $id)->first();
        return view("query-management.query-details", compact("header", "sidebar", "queryDetails"));
    }

    public function store(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'description' => 'required|string|max:10000',
                'query_details_id' => 'required|exists:nhidcl_qms_query_details,id',
            ]);

            if ($validator->fails()) {
                Log::error('Validation Error of Query Reply Controller: ', $validator->errors()->all());
                return redirect()->back()->withErrors($validator->errors()->all())->withInput();
            }

            $replyFile = null;
            if (!empty($request->upload_doc_url)) {
                $doc = extractFileDetails($request->upload_doc_url);
                $replyFile = $doc["fileName"] ?? null;
            }

            // $cleanHtml = Purifier::clean($request->description, [
            //     'HTML.Trusted' => true,
            //     'CSS.AllowTricky' => true,
            //     'Attr.AllowedClasses' => null,
            //     'Attr.EnableID' => true,
            //     // Allow iframe, embed, and object tags safely, if needed
            //     'HTML.SafeEmbed' => true,
            //     'HTML.SafeObject' => true,
            //     'Output.FlashCompat' => true,
            //     'HTML.SafeIframe' => true,
            //     'URI.SafeIframeRegexp' => '#.*#',  // allow any iframe source
            // ]);

            $query = QmsQueryReply::create([
                'nhidcl_qms_query_details_id' => $request->query_details_id,
                'message' => $request->description,
                'file' => $replyFile,
                'created_by' => user_id(),
            ]);

            // If "Mark as Resolved" clicked
            if ($request->action === 'resolve') {
                return $this->markAsResolved($request);
            }

            if ($query) {
                Alert::success('Success', 'Your reply was submitted successfully!');
            } else {
                Alert::error('Error', 'Some error occured.Please try again');
            }
            return redirect()->route('qms.query-details', Crypt::encrypt($request->query_details_id));
        } catch (\Exception $e) {
            Log::error('Exception of Query Reply Controller: ', ['error' => $e->getMessage()]);
            Alert::error('Error', $e->getMessage());
            return redirect()->route('qms.query-details', Crypt::encrypt($request->query_details_id))->withInput();
        }
    }

    public function markAsResolved(Request $request)
    {
        try {
            $request->validate([
                'query_details_id' => 'required|exists:nhidcl_qms_query_details,id',
                'description' => 'required|max:10000',
            ]);

            $query = QmsQueryDetails::findOrFail($request->query_details_id);

            if (!(auth()->user()->can('qms-resolve-query') && auth()->id() !== $query->created_by)) {
                Alert::error('Error', 'You do not have permission to resolve this query.');
                return redirect()->route('qms.raised-query')->withInput();
            }

            $status = NhidclApplicationStatus::whereRaw('LOWER(status) = ?', ['resolved_query'])->first();
            $query->nhidcl_application_status_id = $status->id ?? null;
            $query->updated_by = user_id();
            // $query->remark = $request->description;
            $query->save();

            Alert::success('Success', 'Query marked as resolved.');
            return redirect()->route('qms.raised-query');
        } catch (\Exception $e) {
            Log::error('Error marking query resolved:', ['error' => $e->getMessage()]);
            Alert::error('Error', 'Failed to update query.');
            return redirect()->route('qms.raised-query')->withInput();
        }
    }
}
