<?php

namespace App\Http\Controllers\DirectoryManagement;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use RealRashid\SweetAlert\Facades\Alert;
use Yajra\DataTables\Facades\DataTables;
use App\Models\Role;
use App\Models\User;
use App\Models\DepartmentMaster;
use App\Models\RefEmployeeType;
use App\Models\RefOfficeType;
use App\Models\RefState;
use App\Models\DesignationMaster;
use App\Models\DirectoryManagement\NhidclDosExternalEmployee;
use App\Models\RoleUser;
use Illuminate\Support\Facades\Crypt;
use Exception;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;

class DirectoryManagerController extends Controller
{

    public function __construct()
    {
        $this->middleware(['auth', 'module.access:Directory Management']);
        $this->middleware('module.permission:directory-view')->only(['stakeholderList']);
    }

    public function stakeholderList(Request $request)
    {
        $header = true;
        $sidebar = true;
        return view('directory-management.directory-list', compact('header', 'sidebar'));
    }

    public function externalEmployeeCreate(Request $request)
    {
        if ($request->ajax()) {
            $rendering = $request->get('rendering');
            $query = NhidclDosExternalEmployee::query()
                ->with('state:id,name')
                ->leftJoin('ref_state_master', 'nhidcl_dos_external_employee.ref_state_master_id', '=', 'ref_state_master.id')
                ->select('nhidcl_dos_external_employee.*', 'ref_state_master.name as state_name');

            switch ($rendering) {
                case 'External-Employee':
                    $query->where('nhidcl_dos_external_employee.created_by', auth()->id());
                    break;
                default:
                    $query->where('nhidcl_dos_external_employee.is_active', true);
                    break;
            }

            if (!$request->has('order')) {
                $query->orderBy('nhidcl_dos_external_employee.id', 'desc');
            }

            return DataTables::of($query)
                ->addIndexColumn()
                ->addColumn('action', function ($row) {
                    $buttons = '';
                    if (auth()->user()->can('external-user-edit')) {
                        $buttons .= '<a href="' . route('directory-management.external.employees.edit', Crypt::encrypt($row->id)) . '" class="btn btn-sm btn-warning text-sm me-1">Edit</a>';
                    }
                    if (auth()->user()->can('external-user-delete')) {
                        $buttons .= '<a href="javascript:void(0)" class="btn btn-danger btn-sm deletedata" data-id="' . Crypt::encrypt($row->id) . '" onclick="confirmDelete(\'' . $row->id . '\')">Delete</a>
                        <form id="delete-form-' . $row->id . '" action="' . route('directory-management.external.employees.destroy', Crypt::encrypt($row->id)) . '" method="POST" style="display: none;">' . csrf_field() . method_field('DELETE') . '</form>';
                    };
                    return $buttons ?: '-';
                })
                // ->editColumn('name', fn($row) => $row->name ?? '-')
                ->editColumn('is_active', fn($row) => $row->is_active ? 'Active' : 'Inactive')
                ->filterColumn('is_active', function ($query, $keyword) {
                    if (strtolower($keyword) === 'active') {
                        $query->where('is_active', true);
                    } elseif (strtolower($keyword) === 'inactive') {
                        $query->where('is_active', false);
                    }
                })
                ->editColumn('state', fn($row) => $row->state_name ?? '-')
                ->rawColumns(['action'])
                ->make(true);
        }
        if (!auth()->user()->can(['external-user-create', 'external-user-view', 'external-user-edit'])) {
            abort(403, 'You do not have permission to access this modules.');
        }

        $roles = Role::where('name', '!=', 'Super Admin')->where('name', 'NHIDCL Employee')->orderBy('name', 'asc')->get();
        $state = RefState::orderBy('name', 'asc')->get();
        $header = TRUE;
        $sidebar = TRUE;
        return view('directory-management.employee-create', compact('header', 'sidebar', 'roles', 'state'));
    }

    public function externalEmployeeStore(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'name'   => 'required|string|max:500',
                'email'       => 'required|email|max:500|unique:nhidcl_dos_external_employee,email',
                'mobile'   => 'required|digits:10|unique:nhidcl_dos_external_employee,mobile',
                'designation' => 'required|string|max:500',
                'department'  => 'required|string|max:500',
                'ref_state_master_id'       => 'required|integer|exists:ref_state_master,id',
                'address'     => 'required|string|max:1000',
            ], [
                'full_name.required' => 'Please enter employee full name.',
                'email.required'     => 'Please enter a valid email address.',
                'email.unique'       => 'This email is already registered.',
                'mobile.required' => 'Please enter employee mobile number.',
                'mobile.unique'   => 'This mobile number is already registered.',
                'designation.required' => 'Please enter designation name.',
                'department.required'  => 'Please enter department name.',
                'ref_state_master_id.required'       => 'Please choose employee state.',
                'address.required'     => 'Please enter employee complete address.',
            ]);

            if ($validator->fails()) {
                return redirect()
                    ->back()
                    ->withErrors($validator)
                    ->withInput();
            }

            NhidclDosExternalEmployee::create([
                'name'                => $request->name,
                'email'               => $request->email,
                'mobile'              => $request->mobile,
                'designation'         => $request->designation,
                'department'          => $request->department,
                'ref_state_master_id' => $request->ref_state_master_id,
                'address'             => $request->address,
                'is_active'           => true,
                'is_deleted'          => false,
                'created_by'          => Auth::id(),
            ]);

            Alert::success('Success', 'External employee created successfully');
            return redirect()->route('directory-management.external.employees.create');
        } catch (Exception $e) {
            Alert::error('Error', 'Oops, something went wrong. Please try again later.');
            return redirect()->route('directory-management.external.employees.create')->withInput()->withErrors(['msg' => $e->getMessage()]);
        }
    }

    public function externalEmployeeEdit($id, Request $request)
    {
        if (!auth()->user()->can('external-user-edit')) {
            abort(403, 'You do not have permission to access this modules.');
        }
        $recordId = Crypt::decrypt($id);
        $empData = NhidclDosExternalEmployee::find($recordId);
        $state = RefState::orderBy('name', 'asc')->get();
        $header = true;
        $sidebar = true;
        return view('directory-management.employee-edit', compact('header', 'sidebar', 'empData', 'state'));
    }

    public function externalEmployeeUpdate(Request $request, $id)
    {
        try {
            $employee = NhidclDosExternalEmployee::findOrFail($id);

            $validator = Validator::make($request->all(), [
                'name'   => 'required|string|max:500',
                'email'  => 'required|email|max:500|unique:nhidcl_dos_external_employee,email,' . $employee->id,
                'mobile' => 'required|digits:10|unique:nhidcl_dos_external_employee,mobile,' . $employee->id,
                'designation' => 'required|string|max:500',
                'department'  => 'required|string|max:500',
                'ref_state_master_id' => 'required|integer|exists:ref_state_master,id',
                'address' => 'required|string|max:1000',
                'is_active' => 'required|boolean',
            ], [
                'name.required' => 'Please enter employee full name.',
                'email.required' => 'Please enter a valid email address.',
                'email.unique' => 'This email is already registered.',
                'mobile.required' => 'Please enter employee mobile number.',
                'mobile.unique' => 'This mobile number is already registered.',
                'designation.required' => 'Please enter designation name.',
                'department.required' => 'Please enter department name.',
                'ref_state_master_id.required' => 'Please choose employee state.',
                'address.required' => 'Please enter employee complete address.',
                'is_active.required' => 'Please choose a valid status.',
            ]);

            if ($validator->fails()) {
                return redirect()
                    ->back()
                    ->withErrors($validator)
                    ->withInput();
            }

            $employee->update([
                'name'                => $request->name,
                'email'               => $request->email,
                'mobile'              => $request->mobile,
                'designation'         => $request->designation,
                'department'          => $request->department,
                'ref_state_master_id' => $request->ref_state_master_id,
                'address'             => $request->address,
                'is_active'           => $request->is_active,
                'updated_by'          => Auth::id(),
            ]);

            Alert::success('Success', 'External employee updated successfully');
            return redirect()->route('directory-management.external.employees.create');
        } catch (\Exception $e) {
            Alert::error('Error', 'Oops, something went wrong. Please try again later.');
            return redirect()->route('directory-management.external.employees.create')->withInput()->withErrors(['msg' => $e->getMessage()]);
        }
    }

    public function externalEmployeeDestroy(string $id)
    {
        try {
            $extEmployee = NhidclDosExternalEmployee::find(Crypt::decrypt($id));

            if (!$extEmployee) {
                Alert::error('Error', 'Something went wrong, Please try again.');
                return redirect()->route('directory-management.external.employees.create')
                    ->withInput()
                    ->withErrors(['msg' => 'Something went wrong, Please try again.']);
            }

            // Set updated_by before deleting
            $extEmployee->updated_by = auth()->id();
            $extEmployee->is_deleted = true;
            $extEmployee->save();

            $extEmployee->delete(); // Soft delete (sets deleted_at)

            Alert::success('Success', 'External employee deleted successfully');
            return redirect()->route('directory-management.external.employees.create')->with('success', 'External employee deleted successfully');
        } catch (Exception $e) {
            Log::error('DOS - Error deleting External Employee: ', ['error' => $e->getMessage()]);
            Alert::error('Error', 'Oops, something went wrong. Please try again later');
            return redirect()->route('directory-management.external.employees.create')
                ->withInput()
                ->withErrors(['msg' => $e->getMessage()]);
        }
    }

    public function internalEmployeeDataList(Request $request)
    {
        if ($request->ajax()) {
            $users = User::where('is_deleted', '!=', '1')
                ->where('is_nhidcl_employee', true)
                // ->whereHas('officeType', function ($query) {
                //     $query->whereIn('name', ['HQ', 'RO', 'PMO']);
                // })
                ->select([
                    'id',
                    'name',
                    'email',
                    'mobile',
                    'ref_designation_id',
                    'ref_department_id',
                    'currently_posted',
                    'ref_office_type_id',
                    'address',
                ])
                ->with('officeType');
            $users = $users->orderBy('id', 'DESC')->get();

            return DataTables::of($users)
                ->addIndexColumn()
                ->addColumn('action', function ($row) {
                    $editUrl = route('user-config.edit', Crypt::encrypt($row->id));
                    $actionBtn = '<a href="' . $editUrl . '" class="btn btn-primary btn-sm">Edit</a>';
                    return $actionBtn;
                })
                ->editColumn('department_master', function ($row) {
                    return $row->department?->name ?? '';
                })
                ->editColumn('designation_master', function ($row) {
                    return $row->designation?->name ?? '';
                })
                ->editColumn('posting_master', function ($row) {
                    return $row->posting?->name ?? '';
                })
                ->editColumn('office_master', function ($row) {
                    return $row->officeType?->name ?? '';
                })
                ->editColumn('roles', function ($row) {
                    return $row->roles->pluck('name')->implode(', ');
                })
                ->rawColumns(['action'])
                ->make(true);
        }
    }

    // Old Functions backup

    // public function externalEmployeeCreate(Request $request)
    // {
    //     if ($request->ajax()) {
    //         $users = User::where('is_deleted', '!=', '1')
    //             ->whereHas('roles', function ($query) {
    //                 $query->where('name', 'NHIDCL Employee');
    //             })
    //             ->select([
    //                 'id',
    //                 'name',
    //                 'email',
    //                 'mobile',
    //                 'ref_designation_id',
    //                 'ref_department_id',
    //                 'currently_posted',
    //                 'address',
    //                 'userid_status',
    //             ])
    //             ->with('roles'); // Eager loading roles to optimize queries
    //         $users = $users->orderBy('id', 'DESC')->get();

    //         return DataTables::of($users)
    //             ->addIndexColumn()
    //             ->addColumn('action', function ($row) {
    //                 $editUrl = route('directory-management.external.employees.edit', Crypt::encrypt($row->id));
    //                 $actionBtn = '<a href="' . $editUrl . '" class="btn btn-primary btn-sm">Edit</a>';
    //                 return $actionBtn;
    //             })
    //             ->editColumn('department_master', function ($row) {
    //                 return $row->department?->name ?? '';
    //             })
    //             ->editColumn('designation_master', function ($row) {
    //                 return $row->designation?->name ?? '';
    //             })
    //             ->editColumn('posting_master', function ($row) {
    //                 return $row->posting?->name ?? '';
    //             })
    //             ->editColumn('status_master', function ($row) {
    //                 return $row->userid_status ?? 'Pending';
    //             })
    //             ->editColumn('roles', function ($row) {
    //                 return $row->roles->pluck('name')->implode(', ');
    //             })
    //             ->rawColumns(['action'])
    //             ->make(true);
    //     }
    //     if (!auth()->user()->can(['external-user-create', 'external-user-view', 'external-user-edit'])) {
    //         abort(403, 'You do not have permission to access this modules.');
    //     }

    //     $roles = Role::where('name', '!=', 'Super Admin')->where('name', 'NHIDCL Employee')->orderBy('name', 'asc')->get();
    //     $department = DepartmentMaster::orderBy('name', 'asc')->get();
    //     $designation = DesignationMaster::orderBy('name', 'asc')->get();
    //     $emptype = RefEmployeeType::orderBy('name', 'asc')->get();
    //     $officetype = RefOfficeType::orderBy('office_type_name', 'asc')->get();
    //     $state = RefState::orderBy('name', 'asc')->get();
    //     $header = TRUE;
    //     $sidebar = TRUE;
    //     return view('directory-management.employee-create', compact('header', 'sidebar', 'roles', 'department', 'designation', 'emptype', 'officetype', 'state'));
    // }


    // public function externalEmployeeStore(Request $request)
    // {
    //     try {
    //         $validated = $request->validate([
    //             'full_name' => 'required|string|max:255',
    //             'email' => 'required|email|unique:ref_users,email',
    //             'mobile_no' => 'required|digits:10|unique:ref_users,mobile',
    //             'date_of_birth' => 'required|date|before:today',
    //             'designation' => 'required|integer',
    //             'department' => 'required|integer',
    //             'state' => 'required|integer',
    //             'address' => 'nullable|string|max:255',
    //         ]);

    //         // 2. Insert data after validation
    //         $generatedPassword = 'password123'; // Hardcoded password for now
    //         $insertData = array(
    //             'name' => htmlspecialchars($validated['full_name']),
    //             'email' => htmlspecialchars($validated['email']),
    //             'mobile' => $validated['mobile_no'],
    //             'date_of_birth' => $validated['date_of_birth'],
    //             'ref_designation_id' => $validated['designation'],
    //             'ref_department_id' => $validated['department'],
    //             'currently_posted' => $validated['state'],
    //             'address' => $validated['address'],
    //             'created_by' => auth()->user()->id,
    //             'userid_status' => '1',
    //             'password' => bcrypt($generatedPassword),
    //             'user_code' => rand() . time(),
    //         );

    //         // 3. Create the user
    //         $user = User::create($insertData);
    //         /*********** Syncing role and parent Role with user ***********/
    //         $role = Role::find($request->roles);
    //         if ($role) {
    //             // Spatie sync by role name
    //             $user->syncRoles([$role->name]);

    //             // Insert into your custom table
    //             RoleUser::create([
    //                 'ref_user_id'   => $user->id,
    //                 'role_id'       => $role->id,
    //                 'parent_role_id' => $role->parent_role_id,
    //             ]);
    //         }
    //         Alert::success('Success', 'External employee created successfully');
    //         return redirect()->route('directory-management.external.employees.create');
    //     } catch (Exception $e) {
    //         Alert::error('Error', 'Oops, something went wrong. Please try again later.');
    //         return redirect()->route('directory-management.external.employees.create')->withInput()->withErrors(['msg' => $e->getMessage()]);
    //     }
    // }


    // public function externalEmployeeEdit($id, Request $request)
    // {
    //     if (!auth()->user()->can('external-user-edit')) {
    //         abort(403, 'You do not have permission to access this modules.');
    //     }
    //     $recordId = Crypt::decrypt($id);
    //     $users = User::find($recordId);
    //     $roles = Role::where('name', '!=', 'Super Admin')->where('name', 'NHIDCL Employee')->orderBy('name', 'asc')->get();
    //     $department = DepartmentMaster::orderBy('name', 'asc')->get();
    //     $designation = DesignationMaster::orderBy('name', 'asc')->get();
    //     $emptype = RefEmployeeType::orderBy('name', 'asc')->get();
    //     $officetype = RefOfficeType::orderBy('office_type_name', 'asc')->get();
    //     $state = RefState::orderBy('name', 'asc')->get();
    //     $header = true;
    //     $sidebar = true;
    //     return view('directory-management.employee-edit', compact('header', 'sidebar', 'users', 'roles', 'department', 'designation', 'emptype', 'officetype', 'state'));
    // }

    // public function externalEmployeeUpdate(Request $request, $id)
    // {
    //     $user = User::findOrFail($id); // better than just find()
    //     try {
    //         // Validation (ignore unique check for the same user)
    //         $validated = $request->validate([
    //             'full_name'     => 'required|string|max:255',
    //             'email'         => 'required|email|unique:ref_users,email,' . $id,
    //             'mobile_no'     => 'required|digits:10|unique:ref_users,mobile,' . $id,
    //             'date_of_birth' => 'required|date|before:today',
    //             'designation'   => 'required|integer',
    //             'department'    => 'required|integer',
    //             'state'         => 'required|integer',
    //             'address'       => 'nullable|string|max:255',
    //             'roles'         => 'required|integer'
    //         ]);

    //         // Prepare update data
    //         $updateData = [
    //             'name'              => htmlspecialchars($validated['full_name']),
    //             'email'             => htmlspecialchars($validated['email']),
    //             'mobile'            => $validated['mobile_no'],
    //             'date_of_birth'     => $validated['date_of_birth'],
    //             'ref_designation_id' => $validated['designation'],
    //             'ref_department_id' => $validated['department'],
    //             'currently_posted'  => $validated['state'],
    //             'address'           => $validated['address'] ?? null,
    //         ];

    //         // Update the user
    //         $user->update($updateData);

    //         // Sync role
    //         $role = Role::find($validated['roles']);
    //         if ($role) {
    //             $user->syncRoles([$role->name]);

    //             // Delete old role-user mapping (avoid duplicates)
    //             RoleUser::where('ref_user_id', $user->id)->delete();

    //             // Insert updated mapping
    //             RoleUser::create([
    //                 'ref_user_id'   => $user->id,
    //                 'role_id'       => $role->id,
    //                 'parent_role_id' => $role->parent_role_id,
    //             ]);
    //         }

    //         Alert::success('Success', 'External employee updated successfully');
    //         return redirect()->route('directory-management.external.employees.create');
    //     } catch (\Exception $e) {
    //         Alert::error('Error', 'Oops, something went wrong. Please try again later.');
    //         return redirect()->route('directory-management.external.employees.create')->withInput()->withErrors(['msg' => $e->getMessage()]);
    //     }
    // }
}
